<!-- START OF FILE —Å–∞–π—Ç.html -->
<!-- VERSION 14.0: PREMIUM PRODUCT MODAL + BUY NOW LOGIC + LEGAL TEXT FIX -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flower Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;1,600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê --- */
            --bg: #000000;
            --block: #1C1C1E;
            --text: #FFFFFF;
            --text-sec: #8E8E93;
            --input-bg: #2C2C2E;
            --accent: #E75A7C;
            --green: #32D74B;
            --red: #FF453A;
            --border: rgba(255,255,255,0.1);
            --shadow-color: rgba(0,0,0,0.3);
            
            --header-glass: rgba(20, 30, 25, 0.4); 
            --nav-glass: rgba(28, 28, 30, 0.6);
            --footer-glass: rgba(28, 28, 30, 0.95);
        }

        body.light-theme {
            --bg: #F2F2F7;
            --block: #FFFFFF;
            --text: #000000;
            --text-sec: #8E8E93;
            --input-bg: #E5E5EA;
            --border: rgba(0,0,0,0.1);
            --shadow-color: rgba(0,0,0,0.1);
            
            --header-glass: rgba(230, 240, 235, 0.6);
            --nav-glass: rgba(255, 255, 255, 0.7);
            --footer-glass: rgba(255, 255, 255, 0.95);
        }

        html { height: 100%; overflow: hidden; }
        body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background: var(--bg); color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none;
            transition: background 0.3s;
        }

        .app-container {
            display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative;
        }

        /* --- ICONS --- */
        .icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 48px; height: 48px; stroke-width: 1.5; color: var(--text-sec); opacity: 0.5; }

        /* --- HEADER --- */
        header { 
            flex-shrink: 0; height: 63px; 
            background-color: var(--header-glass);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 20; padding: 0; position: absolute; top: 0; left: 0; width: 100%;
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            overflow: hidden; border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        #header-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; z-index: 1; }

        .brand-overlay { 
            position: absolute; bottom: 8px; width: 100%; text-align: center;
            font-family: 'Playfair Display', serif; font-style: italic; font-weight: 600; 
            font-size: 24px; letter-spacing: 1px; color: #fff; 
            text-shadow: 0 2px 15px rgba(0,0,0,0.8); pointer-events: none; z-index: 2;
        }

        /* --- NAV --- */
        nav {
            flex-shrink: 0; height: 70px; 
            background: var(--nav-glass); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
            position: absolute; bottom: 0; left: 0; width: 100%;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }

        .page {
            display: none; width: 100%; height: 100%; overflow-y: scroll; 
            padding-top: 75px; padding-bottom: 90px; box-sizing: border-box;
            overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; 
        }
        .page.active { display: block; }

        /* --- SNOW --- */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .snowflake { position: absolute; top: -10px; color: white; font-size: 1em; opacity: 0.8; user-select: none; animation-name: fall; animation-timing-function: linear; }
        @keyframes fall {
            0% { transform: translateY(-10px) translateX(0px) rotate(0deg); }
            50% { transform: translateY(55vh) translateX(15px) rotate(180deg); }
            100% { transform: translateY(110vh) translateX(-15px) rotate(360deg); }
        }

        /* --- COMMON UI --- */
        .ptr-spinner { height: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; transition: height 0.2s; width: 100%; flex-shrink: 0; margin-top: -10px; }
        .ptr-icon { width: 20px; height: 20px; border: 2px solid var(--border); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        img { -webkit-touch-callout: none; -webkit-user-drag: none; pointer-events: auto; }
        
        .check-circle { width: 20px; height: 20px; border: 2px solid var(--text-sec); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; cursor: pointer; }
        .check-circle.checked { background: var(--accent); border-color: var(--accent); }
        .check-circle svg { width: 12px; height: 12px; stroke: white; stroke-width: 3; opacity: 0; transform: scale(0.5); transition: 0.2s; }
        .check-circle.checked svg { opacity: 1; transform: scale(1); }

        .clean-btn { background: none; border: none; padding: 5px; color: var(--red); font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; border-radius: 8px; transition: background 0.2s; }
        .clean-btn:active { background: rgba(255, 69, 58, 0.1); }
        .sel-all-btn { color: var(--accent); font-size: 14px; background: none; border: none; cursor: pointer; font-weight: 500; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 50% { transform: scale(1.2); } }

        .search-wrap { padding: 0 16px 12px 16px; position: relative;}
        .search-input { width: 100%; padding: 10px 12px 10px 40px; border-radius: 10px; border: none; background: var(--input-bg); color: var(--text); font-size: 16px; outline: none; box-sizing: border-box; }
        .search-icon-abs { position: absolute; left: 28px; top: 10px; color: var(--text-sec); pointer-events: none; }
        
        .grid { display: grid; gap: 12px; padding: 0 16px; grid-template-columns: 1fr 1fr; }
        @media (min-width: 600px) { .grid { grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); } }
        
        .card { background: var(--block); border-radius: 14px; overflow: hidden; position: relative; animation: fadeUp 0.4s backwards; cursor: pointer; box-shadow: 0 4px 15px var(--shadow-color); }
        .card:active { transform: scale(0.97); transition: 0.1s; }
        .slider-wrapper { position: relative; width: 100%; height: 170px; overflow: hidden; }
        .slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 100%; scrollbar-width: none; }
        .slider::-webkit-scrollbar { display: none; }
        .slide { min-width: 100%; height: 100%; scroll-snap-align: center; }
        .slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .dots { position: absolute; bottom: 8px; left: 0; width: 100%; display: flex; justify-content: center; gap: 4px; pointer-events: none; }
        .dot { width: 4px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 50%; }

        .fav-btn { position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; }
        .light-theme .fav-btn { background: rgba(255,255,255,0.8); }
        .fav-btn.is-active svg { fill: var(--red); stroke: var(--red); }
        .fav-btn.active-anim { animation: pop 0.3s ease; }

        .cart-btn { position: absolute; bottom: 10px; right: 10px; width: 34px; height: 34px; background: var(--accent); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; }
        .cart-btn:active { transform: scale(0.9); background: var(--green); }

        .info { padding: 10px; padding-right: 45px; }
        .name { font-weight: 500; font-size: 13px; margin-bottom: 4px; height: 32px; line-height: 1.25; overflow: hidden; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price { font-weight: 700; font-size: 14px; color: var(--text); }
        
        .list-row { display: flex; align-items: center; gap: 12px; background: var(--block); padding: 10px; margin: 10px 16px; border-radius: 12px; animation: fadeUp 0.3s; }
        .list-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .cart-item-name { font-weight: 500; font-size: 13px; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .cart-item-price { color: var(--text-sec); font-size: 13px; margin-top: 2px; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 4px; border-radius: 8px; margin-top: 5px; width: fit-content; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--bg); color: var(--text); border-radius: 6px; font-weight: bold; cursor: pointer; }
        .qty-val { font-weight: 600; min-width: 16px; text-align: center; font-size: 14px; color: var(--text); }

        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #636366; background: none; border: none; cursor: pointer; width: 25%; height: 100%; transition: color 0.2s; }
        .nav-icon { width: 22px; height: 22px; margin-bottom: 3px; stroke: #636366; stroke-width: 2; transition: stroke 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active .nav-icon { stroke: var(--accent); }
        .badge { position: absolute; top: 8px; margin-left: 14px; background: var(--red); color: white; font-size: 9px; font-weight: bold; padding: 1px 5px; border-radius: 8px; display: none; animation: pop 0.3s; z-index: 10; }

        /* MODALS */
        #modal, #settings-modal, #checkout-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 100; overflow-y: auto; touch-action: pan-y; overscroll-behavior-y: contain; }
        #info-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 150; overflow-y: auto; touch-action: pan-y; overscroll-behavior-y: contain; }

        .modal-active { display: block !important; animation: fadeUp 0.3s; }
        
        /* PREMIUM ROUNDED SLIDER */
        .modal-slider-wrap { 
            width: 100%; aspect-ratio: 1 / 1; overflow: hidden; position: relative; background: #000; 
            border-radius: 0 0 24px 24px; /* ROUNDED BOTTOM */
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        
        .modal-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 100%; scrollbar-width: none; }
        .modal-slider::-webkit-scrollbar { display: none; }
        .modal-slide { min-width: 100%; height: 100%; scroll-snap-align: center; display:flex; align-items:center; justify-content:center; position: relative; }
        .modal-slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .modal-dots { position: absolute; bottom: 15px; left: 0; width: 100%; display: flex; justify-content: center; gap: 6px; pointer-events: none; z-index: 5; }
        .modal-dot { width: 6px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.2s; }
        .modal-dot.active { background: #fff; transform: scale(1.2); }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; touch-action: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #lightbox.visible { opacity: 1; }
        #lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; transform-origin: center; transition: transform 0.1s linear; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; cursor: pointer; z-index: 201; }

        /* MODAL CONTENT PADDING FOR FOOTER */
        .modal-content { padding: 24px 20px 100px 20px; max-width: 600px; margin: 0 auto; background: var(--bg); min-height: 300px; position: relative; top: -10px; }
        .back-btn { position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; }
        
        .fav-text-btn { width: 100%; padding: 14px; background: var(--block); border: 1px solid var(--border); color: var(--text); border-radius: 12px; font-size: 15px; font-weight: 600; margin-top: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .fav-text-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(231, 90, 124, 0.1); }
        
        .big-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; margin-top: 12px; cursor: pointer; box-shadow: 0 5px 15px rgba(231, 90, 124, 0.3); transition: all 0.3s; }
        .big-btn:disabled { background: var(--input-bg); color: var(--text-sec); box-shadow: none; cursor: not-allowed; opacity: 0.6; }

        .input-group { position: relative; margin-bottom: 15px; }
        
        .checkout-input, .checkout-textarea, .checkout-select { width: 100%; padding: 14px 14px 14px 45px; border-radius: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 16px; outline: none; box-sizing: border-box; transition: border-color 0.2s; }
        .checkout-input:focus, .checkout-textarea:focus { border-color: var(--accent); }
        .checkout-textarea { resize: vertical; min-height: 80px; padding-left: 14px; }
        .checkout-select { appearance: none; -webkit-appearance: none; background-repeat: no-repeat; background-position: right 14px center; }
        .input-icon { position: absolute; left: 14px; top: 14px; color: var(--text-sec); pointer-events: none; }

        .promo-wrap { display: flex; gap: 8px; margin-bottom: 15px; }
        .promo-btn { background: var(--block); border: 1px solid var(--border); color: var(--text); border-radius: 10px; padding: 0 15px; font-weight: 600; font-size: 14px; cursor: pointer; }
        .promo-status { font-size: 13px; margin-top: -8px; margin-bottom: 12px; }
        .promo-success { color: var(--green); }
        .promo-error { color: var(--red); }

        .input-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-sec); margin-bottom: 6px; margin-left: 4px; }
        
        #address-suggestions { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; background: var(--block); border: 1px solid var(--border); border-top: none; border-radius: 0 0 10px 10px; box-shadow: 0 4px 10px var(--shadow-color); max-height: 250px; overflow-y: auto; }
        .suggestion-item { padding: 12px 14px; font-size: 15px; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text); }
        .suggestion-item:last-child { border-bottom: none; }
        
        .head-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-top: 15px; margin-bottom: 10px; }
        .head-title { font-size: 20px; font-weight: 800; margin: 0; }
        
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--block); margin-bottom: 1px; cursor: pointer; }
        .settings-item:first-child { border-radius: 14px 14px 0 0; }
        .settings-item:last-child { border-radius: 0 0 14px 14px; }
        .settings-left { display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .settings-icon { color: var(--text-sec); }
        .settings-arrow { color: var(--text-sec); opacity: 0.5; }

        .toggle-switch { position: relative; width: 50px; height: 30px; }
        .toggle-input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #39393D; transition: .4s; border-radius: 34px; }
        .light-theme .toggle-slider { background-color: #E9E9EA; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-input:checked + .toggle-slider { background-color: var(--green); }
        .toggle-input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        .empty-state { text-align: center; color: var(--text-sec); margin-top: 60px; font-size: 15px; display:flex; flex-direction:column; align-items:center; gap:15px; }
        
        .legal-text { color: var(--text); font-size: 14px; line-height: 1.5; white-space: pre-wrap; margin-bottom: 20px; }
        .legal-text h3 { font-size: 16px; font-weight: 700; margin-top: 20px; margin-bottom: 10px; color: var(--accent); }
        
        .info-block { background: var(--block); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .info-label { color: var(--text-sec); }
        .info-val { font-weight: 500; text-align: right; max-width: 60%; }

        /* LEGAL CHECKBOX STYLE */
        .legal-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 0; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid var(--text-sec); border-radius: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .custom-checkbox.checked { background: var(--accent); border-color: var(--accent); }
        .custom-checkbox svg { width: 14px; height: 14px; stroke: white; opacity: 0; transition: 0.2s; }
        .custom-checkbox.checked svg { opacity: 1; }
        .legal-label { font-size: 12px; color: var(--text-sec); line-height: 1.4; cursor: pointer; }
        .legal-link { color: var(--accent); text-decoration: underline; cursor: pointer; font-weight: 600; }
        
        .delivery-note { background: rgba(231, 90, 124, 0.1); border: 1px solid rgba(231, 90, 124, 0.3); border-radius: 10px; padding: 10px; margin-bottom: 20px; font-size: 13px; color: var(--text); line-height: 1.4; display: flex; align-items: center; gap: 10px; }

        .delivery-details-box {
            background: var(--block);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            display: none; 
        }
        .dd-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; }
        .dd-row:last-child { margin-bottom: 0; }
        .dd-label { color: var(--text-sec); }
        .dd-val { font-weight: 600; color: var(--text); }
        .dd-accent { color: var(--accent); }

        /* --- DATE & TIME PICKER STYLE --- */
        .date-scroll { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; scrollbar-width: none; padding-bottom: 5px; }
        .date-scroll::-webkit-scrollbar { display: none; }
        .date-chip { 
            flex-shrink: 0; padding: 10px 16px; background: var(--block); border: 1px solid var(--border); 
            border-radius: 10px; color: var(--text); font-size: 14px; cursor: pointer; text-align: center; min-width: 70px;
        }
        .date-chip.selected { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 4px 10px rgba(231, 90, 124, 0.3); }
        
        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 5px; }
        .time-slot { 
            padding: 10px; background: var(--block); border: 1px solid var(--border); border-radius: 10px; 
            color: var(--text); font-size: 13px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .time-slot.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; background: rgba(100,100,100,0.1); }
        .time-slot.selected { background: var(--accent); border-color: var(--accent); color: white; }

        /* --- STICKY FOOTER STYLE --- */
        .checkout-footer, .modal-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--footer-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 15px 20px; z-index: 120;
            box-shadow: 0 -5px 20px var(--shadow-color);
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
            border-radius: 24px 24px 0 0;
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            will-change: transform;
        }
        
        .checkout-footer.hidden { transform: translateY(120%); }
        #order-form { padding-bottom: 160px; }
        .static-footer-block { margin-top: 30px; padding-bottom: 30px; }

        /* --- NEW v14.0: PRODUCT MODAL FOOTER BUTTONS --- */
        .modal-footer { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
        
        .action-btn { flex: 1; padding: 14px; border: none; border-radius: 14px; font-weight: 600; font-size: 15px; cursor: pointer; transition: 0.2s; text-align: center; }
        .buy-now { background: var(--block); color: var(--text); border: 1px solid var(--border); }
        .add-cart { background: var(--accent); color: white; }
        .add-cart:active { transform: scale(0.96); }

        .modal-qty-ctrl { display: flex; align-items: center; justify-content: space-between; background: var(--accent); border-radius: 14px; padding: 6px; flex: 1; height: 46px; box-sizing: border-box;}
        .modal-qty-btn { width: 36px; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; cursor: pointer; }
        .modal-qty-val { color: white; font-weight: 700; font-size: 16px; min-width: 20px; text-align: center; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <header id="main-header">
            <canvas id="header-canvas"></canvas>
            <div class="brand-overlay">Cotton Flowers</div>
        </header>

        <!-- PAGE: HOME -->
        <div id="p-home" class="page active">
            <div class="ptr-spinner"><div class="ptr-icon"></div></div>
            <div class="search-wrap">
                <svg class="icon search-icon-abs" viewBox="0 0 24 24"><path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
                <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ü–≤–µ—Ç–æ–≤..." oninput="doSearch(this.value)">
            </div>
            <div class="grid" id="grid"></div>
        </div>

        <!-- PAGE: CART -->
        <div id="p-cart" class="page">
            <div class="ptr-spinner"><div class="ptr-icon"></div></div>
            <div class="head-row">
                <h2 class="head-title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <div style="display:flex; gap:10px">
                    <button class="clean-btn" id="cart-del-btn" onclick="deleteSelectedCart()" style="display:none">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <button class="sel-all-btn" onclick="toggleAllCart()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                </div>
            </div>
            <div id="cart-items"></div>
            <div class="empty-state" id="cart-empty" style="display:none">
                <svg class="icon icon-xl" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                <span>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</span>
            </div>
            <div id="cart-footer" style="padding: 15px; max-width: 600px; margin: 0 auto; display:none">
                <div style="text-align: right; font-weight: 600; font-size: 18px; margin-bottom: 15px;">
                    –ò—Ç–æ–≥–æ: <span id="total-price" style="color: var(--accent)">0</span> ‚ÇΩ
                </div>
                <button class="big-btn" id="checkout-btn" onclick="openCheckoutModal()" disabled>–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
            </div>
        </div>

        <!-- PAGE: FAV -->
        <div id="p-fav" class="page">
            <div class="ptr-spinner"><div class="ptr-icon"></div></div>
            <div class="head-row">
                <h2 class="head-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
                <div style="display:flex; gap:15px">
                    <button class="clean-btn" onclick="clearFav()">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
            </div>
            <div class="grid" id="fav-items"></div>
            <div class="empty-state" id="fav-empty" style="display:none">
                <svg class="icon icon-xl" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <span>–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</span>
            </div>
        </div>

        <!-- PAGE: PROFILE -->
        <div id="p-prof" class="page">
            <div class="ptr-spinner"><div class="ptr-icon"></div></div>
            <div style="text-align: center; padding: 40px 20px;">
                <div style="width: 80px; height: 80px; background: var(--block); border-radius: 50%; margin: 0 auto 15px; display:flex; align-items:center; justify-content:center; border: 2px solid var(--border); overflow:hidden" id="u-ava">
                    <svg class="icon" style="width:40px;height:40px;color:var(--text-sec)" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </div>
                <h2 id="u-name" style="margin: 0; font-size: 20px;">–ì–æ—Å—Ç—å</h2>
            </div>
            <div style="padding: 0 16px; max-width: 600px; margin: 0 auto;">
                
                <div class="settings-item" onclick="openInfo('delivery')">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/></svg>
                        <span>üöö –î–æ—Å—Ç–∞–≤–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>

                <div class="settings-item" onclick="openInfo('contacts')">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        <span>–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>

                <div class="settings-item" onclick="openInfo('offer')">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <span>–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>

                <div class="settings-item" onclick="openInfo('privacy')">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        <span>–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>

                <div class="settings-item" onclick="openInfo('newsletter')">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        <span>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>

                <div class="settings-item" onclick="openSupport()">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Telegram</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>

                <div class="settings-item" onclick="openSettings()">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </div>
                    <svg class="icon icon-sm settings-arrow" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
                </div>
            </div>
        </div>

        <!-- NAVBAR -->
        <nav>
            <button class="nav-item active" onclick="go('home', this)">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="nav-text">–ö–∞—Ç–∞–ª–æ–≥</span>
            </button>
            <button class="nav-item" style="position:relative" onclick="go('cart', this)">
                <span class="badge" id="badge">0</span>
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                <span class="nav-text">–ö–æ—Ä–∑–∏–Ω–∞</span>
            </button>
            <button class="nav-item" onclick="go('fav', this)">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <span class="nav-text">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
            </button>
            <button class="nav-item" onclick="go('prof', this)">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <span class="nav-text">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
        </nav>
    </div>
    
    <div id="snow-container"></div>

    <!-- PRODUCT MODAL -->
    <div id="modal">
        <div class="back-btn" onclick="closeModal()">
            <svg class="icon" style="stroke:white" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" /></svg>
        </div>
        <div class="modal-slider-wrap">
            <div class="modal-slider" id="m-slider"></div>
            <div class="modal-dots" id="m-dots"></div>
        </div>
        <div class="modal-content">
            <h1 id="m-title" style="margin: 0; font-size: 22px; line-height: 1.2;"></h1>
            <div id="m-price" style="font-size: 24px; font-weight: 700; color: var(--accent); margin: 8px 0;"></div>
            <p id="m-desc" style="line-height: 1.6; color: var(--text-sec); margin-bottom: 20px; font-size: 15px;"></p>
            
            <div class="delivery-note">
                <svg class="icon" style="min-width:20px; color:var(--accent)" viewBox="0 0 24 24"><path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/></svg>
                <span>–î–æ—Å—Ç–∞–≤–∫–∞ –≤ —Ä–µ–≥–∏–æ–Ω—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è <b>–°–î–≠–ö</b>. –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏, –∞ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¢–ö.</span>
            </div>

            <button class="fav-text-btn" id="m-fav-btn" onclick="toggleModalFav()">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <span>–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
            </button>
        </div>
        <!-- PREMIUM STICKY PRODUCT FOOTER -->
        <div class="modal-footer" id="modal-footer">
            <!-- Buttons injected by JS -->
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox">
        <div class="lightbox-close" onclick="closeLightbox()">‚úï</div>
        <img id="lightbox-img" src="">
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal">
        <div style="padding: 20px;">
            <div style="display:flex; align-items:center; margin-bottom: 20px;">
                <div class="back-btn" style="position:static; margin-right:15px; background:var(--block);" onclick="closeCheckoutModal()">
                    <svg class="icon" style="stroke:var(--text)" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" /></svg>
                </div>
                <h2 style="margin:0">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            </div>
            <form id="order-form" onsubmit="event.preventDefault(); submitOrder();">
                <div class="input-label">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
                <div class="input-group">
                    <svg class="icon input-icon" viewBox="0 0 24 24"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    <input type="tel" class="checkout-input" id="phone-input" placeholder="+7 (XXX) XXX-XX-XX" required oninput="formatPhone(this)" maxlength="18">
                </div>
                <div class="input-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                <div class="input-group">
                    <svg class="icon input-icon" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <input type="text" class="checkout-input" id="address-input" placeholder="–ì–æ—Ä–æ–¥, –£–ª–∏—Ü–∞, –î–æ–º" required>
                    <div id="address-suggestions"></div> 
                </div>

                <!-- INFO BLOCK: DISTANCE & COST -->
                <div id="delivery-details-box" class="delivery-details-box">
                    <div class="dd-row">
                        <span class="dd-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</span>
                        <span class="dd-val" id="dd-distance">...</span>
                    </div>
                    <div class="dd-row">
                        <span class="dd-label">–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</span>
                        <span class="dd-val" id="dd-time">...</span>
                    </div>
                    <div class="dd-row">
                        <span class="dd-label">–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                        <span class="dd-val dd-accent" id="dd-price">...</span>
                    </div>
                </div>

                <!-- DATE & TIME PICKER -->
                <div id="date-time-container">
                    <div class="input-label" id="date-label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ / –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
                    <div class="date-scroll" id="date-scroll"></div>
                    
                    <div id="time-block">
                        <div class="input-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏ (10:00 - 00:00)</div>
                        <div class="time-grid" id="time-grid"></div>
                        <div style="font-size:11px; color:var(--text-sec); margin-top:5px; margin-left:4px;">
                            –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å–∫—Ä—ã—Ç—ã (—Å–±–æ—Ä–∫–∞ 2—á + –¥–æ—Ä–æ–≥–∞).
                        </div>
                    </div>
                </div>

                <div class="input-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</div>
                <div class="input-group">
                    <textarea class="checkout-textarea" id="comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –ø–æ–∂–µ–ª–∞–Ω–∏—è, —Ç–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏, –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏..."></textarea>
                </div>
                <div class="input-label">–ü—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑)</div>
                <div class="promo-wrap">
                    <div style="position:relative; width:100%">
                         <svg class="icon input-icon" viewBox="0 0 24 24"><path d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                        <input type="text" class="checkout-input" id="promo-input" placeholder="–ö–æ–¥ —Å–∫–∏–¥–∫–∏">
                    </div>
                    <button type="button" class="promo-btn" onclick="applyPromo()">OK</button>
                </div>
                <div id="promo-status" class="promo-status"></div>

                <div style="text-align: right; font-weight: 600; font-size: 16px; margin-top: 5px; margin-bottom: 5px;">
                    –ö –æ–ø–ª–∞—Ç–µ: <span id="checkout-total-price" style="color: var(--accent)">0</span> ‚ÇΩ
                </div>

                <!-- STATIC FOOTER BLOCK (MARKETPLACE EFFECT) -->
                <div class="static-footer-block" id="static-pay-block">
                    <div class="legal-row" onclick="toggleCheckoutSubmit()">
                        <div class="custom-checkbox legal-check-icon">
                            <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                        </div>
                        <div class="legal-label">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <span class="legal-link" onclick="event.stopPropagation(); openInfo('offer')">—É—Å–ª–æ–≤–∏—è–º–∏ –æ—Ñ–µ—Ä—Ç—ã</span>, <span class="legal-link" onclick="event.stopPropagation(); openInfo('privacy')">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</span> –∏ <span class="legal-link" onclick="event.stopPropagation(); openInfo('newsletter')">–ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ä–∞—Å—Å—ã–ª–æ–∫</span>.</div>
                    </div>
                    <button type="button" class="big-btn final-pay-btn-class" disabled onclick="submitOrder()">–û–ü–õ–ê–¢–ò–¢–¨</button>
                </div>

            </form>
            
            <!-- STICKY FOOTER (HIDDEN WHEN SCROLLED TO BOTTOM) -->
            <div class="checkout-footer" id="sticky-footer">
                <div class="legal-row" onclick="toggleCheckoutSubmit()">
                    <div class="custom-checkbox legal-check-icon">
                        <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <div class="legal-label">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <span class="legal-link" onclick="event.stopPropagation(); openInfo('offer')">—É—Å–ª–æ–≤–∏—è–º–∏ –æ—Ñ–µ—Ä—Ç—ã</span>, <span class="legal-link" onclick="event.stopPropagation(); openInfo('privacy')">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</span> –∏ <span class="legal-link" onclick="event.stopPropagation(); openInfo('newsletter')">–ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ä–∞—Å—Å—ã–ª–æ–∫</span>.</div>
                </div>
                <button type="button" class="big-btn final-pay-btn-class" disabled onclick="submitOrder()">–û–ü–õ–ê–¢–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal">
        <div style="padding: 20px;">
            <div style="display:flex; align-items:center; margin-bottom: 20px;">
                <div class="back-btn" style="position:static; margin-right:15px; background:var(--block);" onclick="closeSettings()">
                    <svg class="icon" style="stroke:var(--text)" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" /></svg>
                </div>
                <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div style="background: var(--block); border-radius: 14px; overflow:hidden;">
                <div class="settings-item" style="cursor:default">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                        <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" class="toggle-input" id="theme-toggle" onchange="toggleTheme()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item" style="cursor:default">
                    <div class="settings-left">
                        <svg class="icon settings-icon" viewBox="0 0 24 24"><path d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>English Language</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" class="toggle-input" id="lang-toggle" onchange="toggleLang()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- INFO MODAL -->
    <div id="info-modal">
        <div style="padding: 20px;">
            <div style="display:flex; align-items:center; margin-bottom: 20px;">
                <div class="back-btn" style="position:static; margin-right:15px; background:var(--block);" onclick="closeInfo()">
                    <svg class="icon" style="stroke:var(--text)" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" /></svg>
                </div>
                <h2 id="info-title" style="margin:0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            </div>
            <div id="info-content"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const SUPPORT_USERNAME = 'DUROV'; 
        const DADATA_TOKEN = '69386c882701ec813abcc78b9973d255aacf9f60'; 

        const db = [
            { id: 1, name: "–ì–µ–ª–∏—Ö—Ä–∏–∑—É–º —Å–æ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–æ–∑–æ–π", price: 1500, desc: "–°–æ—Å—Ç–∞–≤: –†–æ–∑–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - 1 —à—Ç. –ì—É–±–∫–∞ —Ñ–ª–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è - 1 —à—Ç. –ü–∞–º–ø–∞—Å–Ω–∞—è —Ç—Ä–∞–≤–∞ - 1 —à—Ç. –§–∞–ª–∞—Ä–∏—Å —Å—É—Ö–æ—Ü–≤–µ—Ç - 3 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/71/1759415719_47099271.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/48/1759415735_22242048.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/45/1759415748_93858245.jpg"] },
            { id: 2, name: "–ö–æ—Ä–∑–∏–Ω–æ—á–∫–∞ —Å –∞—Ä–æ–º–∞—Ç–Ω—ã–º –Ω–æ–±–∏–ª–∏—Å–æ–º", price: 3500, desc: "–ù–æ–±–∏–ª–∏—Å - 3 —à—Ç. –ò–≥—Ä—É—à–∫–∞ –µ–ª–æ—á–Ω–∞—è - 5 —à—Ç. –•–ª–æ–ø–æ–∫ (—Å—É—Ö–æ—Ü–≤–µ—Ç) - 1 —à—Ç. –ì—É–±–∫–∞ —Ñ–ª–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è - 1 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/27/1766478201_42725527.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/75/1766478332_27661575.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/92/1766478389_74341492.jpg"] },
            { id: 3, name: "–°–∏—Ä–µ–Ω–µ–≤–∞—è –∫–æ—Ä–∑–∏–Ω–∫–∞", price: 2900, desc: "–†–æ–∑–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - 1 —à—Ç. –õ–∞–≤–∞–Ω–¥–∞ —Å—É—Ö–æ—Ü–≤–µ—Ç - 3 —à—Ç. –õ–∞–≥—É—Ä—É—Å (—Å—É—Ö–æ—Ü–≤–µ—Ç) - 7 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/10/1764221989_49879210.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/46/1764221999_81902046.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/74/1764222021_89252974.jpg"] },
            { id: 4, name: "–ö–æ—Ä–∑–∏–Ω–∞ —Å —Ä–æ–∑–∞–º–∏", price: 3799, desc: "–†–æ–∑–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - 2 —à—Ç. –ì—É–±–∫–∞ —Ñ–ª–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è - 1 —à—Ç. –õ–∏–º–æ–Ω–∏—É–º —Å—É—Ö–æ—Ü–≤–µ—Ç - 1 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/31/1763281452_32652531.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/35/1763281462_98317735.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/05/1763281484_77855005.jpg"] },
            { id: 5, name: "–ù–µ–∂–Ω—ã–π –º–∏–Ω–∏ –±—É–∫–µ—Ç", price: 1500, desc: "–£–ø–∞–∫–æ–≤–∫–∞ –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è - 1 —à—Ç. –•–ª–æ–ø–æ–∫ (—Å—É—Ö–æ—Ü–≤–µ—Ç) - 3 —à—Ç. –õ–∞–≤–∞–Ω–¥–∞ –ø—É—á–æ–∫ (—Å—É—Ö–æ—Ü–≤–µ—Ç) - 1 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/524x524/61/1725257322_91107361.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/95/1725257322_98564295.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/88/1725257323_96342188.jpg"] },
            { id: 6, name: "–ö–æ—Ä–∑–∏–Ω–∞ —Å –ø–æ–¥—Å–æ–ª–Ω—É—Ö–æ–º", price: 3800, desc: "–ö—Ä–∞—Å–ø–µ–¥–∏—è –∂–µ–ª—Ç–∞—è - 2 —à—Ç. –•–ª–æ–ø–æ–∫ (—Å—É—Ö–æ—Ü–≤–µ—Ç) - 2 —à—Ç. –≠–≤–∫–∞–ª–∏–ø—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π - 1 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/524x524/13/1744103681_29991113.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/13/1744103681_78106913.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/98/1744103681_60463898.jpg"] }
        ];

        let cart = JSON.parse(localStorage.getItem('cart_v7')) || [];
        let favs = JSON.parse(localStorage.getItem('favs_v7')) || [];
        let selectedCart = new Set();
        let currentId = null;
        let checkoutTotalPrice = 0;
        let currentDiscount = 0;
        let appliedPromoCode = "";

        let globalDeliveryPrice = 0;
        let isLegalChecked = false;

        // ==========================================
        // üöÄ –õ–û–ì–ò–ö–ê –î–û–°–¢–ê–í–ö–ò
        // ==========================================
        
        const WAREHOUSE_LAT = 55.755814; 
        const WAREHOUSE_LON = 37.617635;
        const ASSEMBLY_TIME_MINUTES = 120; // 2 —á–∞—Å–∞ –Ω–∞ —Å–±–æ—Ä–∫—É

        const DELIVERY_ZONES = {
            "Moscow": { base: 0, perKm: 40 },
            "Sankt-Peterburg": 600,
            "Krasnodar": 750,
            "Novosibirsk": 900,
            "Yekaterinburg": 850,
            "Kazan": 700,
            "Nizhny Novgorod": 650,
            "Rostov": 750,
            "Samara": 700,
            "Ufa": 750,
            "Vladivostok": 1200
        };
        const DEFAULT_RUSSIA_PRICE = 850; 

        let deliveryDurationMinutes = 0;
        let isRegionalDelivery = false;
        
        // Date/Time Selection Variables
        let selectedDate = null;
        let selectedTimeSlot = null;

        function deg2rad(deg) { return deg * (Math.PI/180); }
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }

        function updateDeliveryInfoUI(distKm, durationMins, priceText, isRegional) {
            const box = document.getElementById('delivery-details-box');
            box.style.display = 'block';

            document.getElementById('dd-distance').innerText = distKm + " –∫–º";
            
            if (isRegional) {
                document.getElementById('dd-time').innerText = "~ 5-7 –¥–Ω–µ–π (–°–î–≠–ö)";
            } else {
                const hours = Math.floor(durationMins / 60);
                const mins = Math.floor(durationMins % 60);
                let timeStr = "";
                if(hours > 0) timeStr += hours + " —á. ";
                timeStr += mins + " –º–∏–Ω.";
                document.getElementById('dd-time').innerText = timeStr;
            }

            document.getElementById('dd-price').innerText = priceText;

            deliveryDurationMinutes = durationMins;
            isRegionalDelivery = isRegional;
            initDateScroll(); 
        }

        // --- TIME SLOT LOGIC ---
        function initDateScroll() {
            const container = document.getElementById('date-scroll');
            const timeBlock = document.getElementById('time-block');
            
            // –ï—Å–ª–∏ —Ä–µ–≥–∏–æ–Ω (–°–î–≠–ö) - —Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
            if (isRegionalDelivery) {
                timeBlock.style.display = 'none';
                document.getElementById('date-label').innerText = "–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–°–î–≠–ö)";
            } else {
                timeBlock.style.display = 'block';
                document.getElementById('date-label').innerText = "–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏";
            }

            container.innerHTML = '';
            const today = new Date();
            
            for (let i = 0; i < 14; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                
                const chip = document.createElement('div');
                chip.className = 'date-chip';
                
                if (i === 0) chip.innerText = "–°–µ–≥–æ–¥–Ω—è";
                else if (i === 1) chip.innerText = "–ó–∞–≤—Ç—Ä–∞";
                else {
                    const opts = { day: 'numeric', month: 'short' };
                    chip.innerText = date.toLocaleDateString('ru-RU', opts);
                }

                chip.onclick = () => selectDate(date, chip);
                container.appendChild(chip);
                
                if (i === 0) selectDate(date, chip); 
            }
        }

        function selectDate(date, chipEl) {
            selectedDate = date;
            selectedTimeSlot = null;
            
            document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('selected'));
            chipEl.classList.add('selected');
            
            if (!isRegionalDelivery) {
                renderTimeGrid();
            }
        }

        function renderTimeGrid() {
            const grid = document.getElementById('time-grid');
            grid.innerHTML = '';
            
            const intervals = [
                {s: 10, e: 12}, {s: 12, e: 14}, {s: 14, e: 16}, 
                {s: 16, e: 18}, {s: 18, e: 20}, {s: 20, e: 22}, {s: 22, e: 24}
            ];

            const now = new Date();
            const minTime = new Date();
            minTime.setMinutes(now.getMinutes() + ASSEMBLY_TIME_MINUTES + deliveryDurationMinutes + 15);

            intervals.forEach(inv => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'time-slot';
                const endStr = inv.e === 24 ? "00" : inv.e;
                slotDiv.innerText = `${inv.s}:00 - ${endStr}:00`;
                
                let isDisabled = false;
                const slotStartTime = new Date(selectedDate);
                slotStartTime.setHours(inv.s, 0, 0, 0);

                if (slotStartTime < minTime) {
                    isDisabled = true;
                }

                if (isDisabled) {
                    slotDiv.classList.add('disabled');
                } else {
                    slotDiv.onclick = () => {
                        document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
                        slotDiv.classList.add('selected');
                        selectedTimeSlot = `${inv.s}:00 - ${endStr}:00`;
                    };
                }
                
                grid.appendChild(slotDiv);
            });
        }

        function calculateDeliveryCost(lat, lon, city, region) {
            const dist = getDistanceFromLatLonInKm(WAREHOUSE_LAT, WAREHOUSE_LON, lat, lon);
            const realDist = Math.round(dist * 1.3); 

            let price = 0;
            let text = "";
            let travelTime = 0;
            let isRegional = false;

            // 1. –ö–£–†–¨–ï–†–°–ö–ê–Ø –ó–û–ù–ê (–î–æ 130 –∫–º)
            if (realDist <= 130) {
                if (realDist <= 15) travelTime = realDist * 2.5; 
                else travelTime = (15 * 2.5) + ((realDist - 15) * 1.2);
                
                if (realDist <= 5) { price = 0; text = `–ë–µ—Å–ø–ª–∞—Ç–Ω–æ`; } 
                else if (realDist <= 15) { price = 500; text = `${price} ‚ÇΩ`; } 
                else { price = 500 + (realDist - 15) * 40; text = `${price} ‚ÇΩ`; }
            } 
            else {
                isRegional = true;
                travelTime = 0; 
                let zonePrice = DEFAULT_RUSSIA_PRICE;
                if(city && city.includes("–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥")) zonePrice = DELIVERY_ZONES["Sankt-Peterburg"];
                else if(region && region.includes("–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä")) zonePrice = DELIVERY_ZONES["Krasnodar"];
                
                // PRICE X2 LOGIC FOR CDEK
                price = zonePrice * 2;
                
                text = `~${price} ‚ÇΩ (–°–î–≠–ö)`;
            }

            globalDeliveryPrice = price; // Save globally
            updateCheckoutTotalUI();
            updateDeliveryInfoUI(realDist, travelTime, text, isRegional);
        }

        function updateCheckoutTotalUI() {
            const totalSpan = document.getElementById('checkout-total-price');
            let basePrice = checkoutTotalPrice;
            if (currentDiscount > 0) basePrice = Math.floor(checkoutTotalPrice * (1 - currentDiscount));
            const final = basePrice + globalDeliveryPrice;
            
            if (currentDiscount > 0) {
                 totalSpan.innerHTML = `<s style="color:var(--text-sec);font-size:14px">${checkoutTotalPrice + globalDeliveryPrice}</s> ${final}`;
            } else {
                totalSpan.innerText = final;
            }
        }

        // ==========================================

        function openInfo(type) {
            const modal = document.getElementById('info-modal');
            const title = document.getElementById('info-title');
            const content = document.getElementById('info-content');
            
            if (type === 'contacts') {
                title.innerText = '–ö–æ–Ω—Ç–∞–∫—Ç—ã';
                content.innerHTML = `
                    <div class="info-block">
                        <div class="info-row"><span class="info-label">–ú–∞–≥–∞–∑–∏–Ω</span><span class="info-val">Cotton Flowers</span></div>
                        <div class="info-row"><span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span><span class="info-val">+7 (999) 000-00-00</span></div>
                        <div class="info-row"><span class="info-label">–ê–¥—Ä–µ—Å</span><span class="info-val">–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¶–≤–µ—Ç–æ—á–Ω–∞—è, –¥. 1</span></div>
                    </div>
                `;
            } else if (type === 'delivery') {
                title.innerText = '–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –£–ø–∞–∫–æ–≤–∫–∞';
                content.innerHTML = `
                    <div class="legal-text">
                        <h3>üì¶ –ë–µ—Ä–µ–∂–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞</h3>
                        –ú—ã –ø–æ–Ω–∏–º–∞–µ–º, –∫–∞–∫ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –±—É–∫–µ—Ç –ø—Ä–∏–µ—Ö–∞–ª –≤ –∏–¥–µ–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏. 
                        <ul>
                            <li>–í—Å–µ –±—É–∫–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –∂–µ—Å—Ç–∫–∏—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –∫–æ—Ä–æ–±–∫–∞—Ö.</li>
                            <li>–ñ–∏–≤—ã–µ —Ü–≤–µ—Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ –∞–∫–≤–∞–±–æ–∫—Å —Å –≤–æ–¥–æ–π.</li>
                            <li>–°—É—Ö–æ—Ü–≤–µ—Ç—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è, —á—Ç–æ–±—ã –Ω–µ –æ—Å—ã–ø–∞–ª–∏—Å—å –≤ –ø—É—Ç–∏.</li>
                        </ul>

                        <h3>üöö –ö—É—Ä—å–µ—Ä—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</h3>
                        –î–µ–π—Å—Ç–≤—É–µ—Ç –ø–æ –ú–æ—Å–∫–≤–µ –∏ –æ–±–ª–∞—Å—Ç–∏ (–¥–æ 130 –∫–º).
                        –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å—Ö–æ–¥—è –∏–∑ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è.

                        <h3>‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ä–µ–≥–∏–æ–Ω—ã (–°–î–≠–ö)</h3>
                        –î–ª—è –∞–¥—Ä–µ—Å–æ–≤ –¥–∞–ª–µ–µ 130 –∫–º –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –°–î–≠–ö.
                        –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫: 5-7 –¥–Ω–µ–π.
                    </div>
                `;
            } else if (type === 'offer') {
                title.innerText = '–ü—É–±–ª–∏—á–Ω–∞—è –û—Ñ–µ—Ä—Ç–∞';
                content.innerHTML = `<div class="legal-text">
                    <h3>–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ Cotton Flowers</h3>
                    <p>–ù–∞—Å—Ç–æ—è—â–∞—è –æ—Ñ–µ—Ä—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ò–ü [–í–ê–®–ò –î–ê–ù–ù–´–ï] (–¥–∞–ª–µ–µ - ¬´–ü—Ä–æ–¥–∞–≤–µ—Ü¬ª) –∑–∞–∫–ª—é—á–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.</p>
                    <p>1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è<br>1.1. –ó–∞–∫–∞–∑ –ü–æ–∫—É–ø–∞—Ç–µ–ª–µ–º —Ç–æ–≤–∞—Ä–∞, —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–≥–æ –Ω–∞ —Å–∞–π—Ç–µ, –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–µ–Ω —Å–æ –≤—Å–µ–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –Ω–∞—Å—Ç–æ—è—â–µ–π –û—Ñ–µ—Ä—Ç—ã.<br>1.2. –ü—Ä–æ–¥–∞–≤–µ—Ü –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –û—Ñ–µ—Ä—Ç—É –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ü–æ–∫—É–ø–∞—Ç–µ–ª—è.</p>
                    <p>2. –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ó–∞–∫–∞–∑–∞<br>2.1. –ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ü–æ–∫—É–ø–∞—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å Telegram Web App.<br>2.2. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: –∏–º—è, –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏, —Ç–µ–ª–µ—Ñ–æ–Ω.</p>
                    <p>3. –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞<br>3.1. –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ.<br>3.2. –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å –ÆKassa.</p>
                    <p>–ò–ü [–í–ê–®–ò –î–ê–ù–ù–´–ï]<br>–ò–ù–ù: 0000000000<br>–û–ì–†–ù–ò–ü: 000000000000000</p>
                </div>`;
            } else if (type === 'privacy') {
                title.innerText = '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏';
                content.innerHTML = `<div class="legal-text">
                    <h3>–ü–æ–ª–∏—Ç–∏–∫–∞ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h3>
                    <p>1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è<br>–ù–∞—Å—Ç–æ—è—â–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ –æ—Ç 27.07.2006. ‚Ññ152-–§–ó ¬´–û –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö¬ª –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ä—ã –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–µ –ò–ü [–í–ê–®–ò –î–ê–ù–ù–´–ï].</p>
                    <p>2. –û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:<br>- –§–∞–º–∏–ª–∏—è, –∏–º—è, –æ—Ç—á–µ—Å—Ç–≤–æ;<br>- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞;<br>- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.</p>
                    <p>3. –¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö<br>- –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º;<br>- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ, –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤.</p>
                </div>`;
            } else if (type === 'newsletter') {
                title.innerText = '–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É';
                content.innerHTML = `<div class="legal-text">
                    <h3>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</h3>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –æ—Å—Ç–∞–≤–ª—è—è —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Cotton Flowers, –≤—ã—Ä–∞–∂–∞–µ—Ç —Å–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏.</p>
                    <p>1. –†–∞—Å—Å—ã–ª–∫–∞ –º–æ–∂–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ –≤–∏–¥–µ:<br>- –°–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram;<br>- SMS-—Å–æ–æ–±—â–µ–Ω–∏–π.</p>
                    <p>2. –û—Ç–∫–∞–∑ –æ—Ç —Ä–∞—Å—Å—ã–ª–∫–∏<br>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏, –Ω–∞–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏.</p>
                </div>`;
            }
            modal.classList.add('modal-active');
        }

        function closeInfo() { document.getElementById('info-modal').classList.remove('modal-active'); }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            tg.setBackgroundColor(isLight ? '#F2F2F7' : '#000000');
            tg.setHeaderColor(isLight ? '#FFFFFF' : '#1C1C1E');
        }

        const isLightOnLoad = localStorage.getItem('theme') === 'light';
        if(isLightOnLoad) {
            document.body.classList.add('light-theme');
            document.getElementById('theme-toggle').checked = true;
        }
        tg.setBackgroundColor(isLightOnLoad ? '#F2F2F7' : '#000000');
        tg.setHeaderColor(isLightOnLoad ? '#FFFFFF' : '#1C1C1E');

        function toggleLang() {
            const isEng = document.getElementById('lang-toggle').checked;
            const titles = document.querySelectorAll('.nav-text');
            if(isEng) {
                titles[0].innerText = 'Catalog'; titles[1].innerText = 'Cart'; titles[2].innerText = 'Saved'; titles[3].innerText = 'Profile';
            } else {
                titles[0].innerText = '–ö–∞—Ç–∞–ª–æ–≥'; titles[1].innerText = '–ö–æ—Ä–∑–∏–Ω–∞'; titles[2].innerText = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ'; titles[3].innerText = '–ü—Ä–æ—Ñ–∏–ª—å';
            }
        }

        function openSupport() { tg.openTelegramLink(`https://t.me/${SUPPORT_USERNAME}`); }
        
        function openSettings() { document.getElementById('settings-modal').classList.add('modal-active'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('modal-active'); }
        
        function openCheckoutModal() {
            if(selectedCart.size === 0) return;
            
            // RESET OR RESTORE
            currentDiscount = 0; appliedPromoCode = "";
            document.getElementById('promo-input').value = "";
            document.getElementById('promo-status').innerText = "";
            document.getElementById('checkout-total-price').innerText = checkoutTotalPrice + globalDeliveryPrice; 
            
            if (globalDeliveryPrice === 0) {
                 document.getElementById('delivery-details-box').style.display = 'none';
            }

            // RESET STATE
            isLegalChecked = false;
            updateLegalVisuals();

            document.getElementById('checkout-modal').classList.add('modal-active'); 
            const addressInput = document.getElementById('address-input');
            addressInput.focus();
        }
        function closeCheckoutModal() { document.getElementById('checkout-modal').classList.remove('modal-active'); }

        // --- LEGAL CHECKBOX LOGIC v14.0 (SYNCED & FIXED TEXT) ---
        function toggleCheckoutSubmit() {
            isLegalChecked = !isLegalChecked;
            updateLegalVisuals();
            
            if (isLegalChecked) tg.HapticFeedback.notificationOccurred('success');
            else tg.HapticFeedback.impactOccurred('light');
        }

        function updateLegalVisuals() {
            const checkboxes = document.querySelectorAll('.legal-check-icon');
            const buttons = document.querySelectorAll('.final-pay-btn-class');
            
            checkboxes.forEach(cb => {
                if(isLegalChecked) cb.classList.add('checked');
                else cb.classList.remove('checked');
            });
            
            buttons.forEach(btn => {
                btn.disabled = !isLegalChecked;
            });
        }

        function applyPromo() {
            const code = document.getElementById('promo-input').value.trim().toUpperCase();
            const statusDiv = document.getElementById('promo-status');
            
            if(appliedPromoCode === code && code !== "") return;
            
            if (localStorage.getItem('promo_used_v6')) {
                statusDiv.innerText = "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—è–ª—Å—è —Ä–∞–Ω–µ–µ";
                statusDiv.className = "promo-status promo-error";
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            if (code === "COTTON") {
                currentDiscount = 0.10;
                appliedPromoCode = code;
                statusDiv.innerText = "–°–∫–∏–¥–∫–∞ 10% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞";
                statusDiv.className = "promo-status promo-success";
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                currentDiscount = 0; appliedPromoCode = "";
                statusDiv.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥";
                statusDiv.className = "promo-status promo-error";
                tg.HapticFeedback.notificationOccurred('error');
            }
            updateCheckoutTotalUI();
        }

        function save() { localStorage.setItem('cart_v7', JSON.stringify(cart)); localStorage.setItem('favs_v7', JSON.stringify(favs)); }
        
        function drawCard(p) {
            const isFav = favs.includes(p.id);
            const activeClass = isFav ? 'is-active' : '';
            let slidesHtml = p.images.map(url => `<div class="slide"><img src="${url}" loading="lazy"></div>`).join('');
            return `
                <div class="card" onclick="openModal(${p.id})">
                    <div class="fav-btn ${activeClass}" id="fav-btn-${p.id}" onclick="toggleFav(${p.id}, event)">
                        <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                    </div>
                    <div class="slider-wrapper"><div class="slider">${slidesHtml}</div><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
                    <div class="info"><div class="name">${p.name}</div><div class="price">${p.price} ‚ÇΩ</div></div>
                    <div class="cart-btn" onclick="addOne(${p.id}, event)">
                        <svg class="icon icon-sm" style="stroke:white" viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-5 2a2 2 0 110-4 2 2 0 010 4z"/></svg>
                    </div>
                </div>`;
        }
        function render(list = db, containerId = 'grid') { document.getElementById(containerId).innerHTML = list.map(p => drawCard(p)).join(''); }
        function doSearch(val) { render(db.filter(p => p.name.toLowerCase().includes(val.toLowerCase()))); }

        function toggleFav(id, e) {
            if(e) e.stopPropagation();
            const idx = favs.indexOf(id);
            const homeBtn = document.querySelector(`#p-home #fav-btn-${id}`);
            const onFavPage = document.getElementById('p-fav').classList.contains('active');
            if(idx < 0) { 
                favs.push(id); 
                if(homeBtn) { homeBtn.classList.add('is-active','active-anim'); setTimeout(()=>homeBtn.classList.remove('active-anim'),300); } 
                if(onFavPage) { renderFavs(); }
                tg.HapticFeedback.impactOccurred('medium'); 
            } else { 
                favs.splice(idx, 1); tg.HapticFeedback.impactOccurred('light'); 
                if(onFavPage) {
                    const cardToRemove = document.querySelector(`#fav-items .card[onclick="openModal(${id})"]`);
                    if (cardToRemove) {
                        cardToRemove.style.transition = 'opacity 0.3s, transform 0.3s'; cardToRemove.style.opacity = '0'; cardToRemove.style.transform = 'scale(0.8)';
                        setTimeout(() => { cardToRemove.remove(); if (favs.length === 0) document.getElementById('fav-empty').style.display = 'flex'; }, 300);
                    }
                } 
                if(homeBtn) homeBtn.classList.remove('is-active');
            }
            save(); if(currentId === id) updateModalFavBtn(); 
        }

        function toggleModalFav() { toggleFav(currentId, { stopPropagation: ()=>{} }); }
        function updateModalFavBtn() {
            const btn = document.getElementById('m-fav-btn');
            const span = btn.querySelector('span');
            if(favs.includes(currentId)) { span.innerText='–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º'; btn.classList.add('active'); }
            else { span.innerText='–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'; btn.classList.remove('active'); }
        }

        function addOne(id, e) { 
            if(e) e.stopPropagation(); 
            cart.push(id); save(); 
            updateCartQuantities(); 
            // If Modal is open for this product, refresh its footer
            if(currentId === id) updateModalButtons(id);
            tg.HapticFeedback.impactOccurred('light'); 
        }
        
        function removeOne(id) { 
            const idx = cart.indexOf(id); 
            if (idx > -1) { 
                cart.splice(idx, 1); save(); 
                updateCartQuantities(); 
                // If Modal is open for this product, refresh its footer
                if(currentId === id) updateModalButtons(id);
            } 
        }
        
        function updateTotalAndButtons() {
            const grouped = {}; cart.forEach(id => grouped[id] = (grouped[id] || 0) + 1);
            const ids = Object.keys(grouped).map(Number);
            let selectedTotal = 0;
            ids.forEach(id => { if(selectedCart.has(id)) { const product = db.find(x => x.id == id); if (product) selectedTotal += product.price * grouped[id]; } });
            checkoutTotalPrice = selectedTotal; 
            document.getElementById('cart-del-btn').style.display = selectedCart.size > 0 ? 'flex' : 'none';
            document.getElementById('checkout-btn').disabled = selectedCart.size === 0;
            document.getElementById('total-price').innerText = selectedTotal;
        }
        
        function toggleCartSelect(id) {
            const itemElement = document.getElementById('cart-item-' + id);
            const circle = itemElement ? itemElement.querySelector('.check-circle') : null;
            if(selectedCart.has(id)) { selectedCart.delete(id); if (circle) circle.classList.remove('checked'); } 
            else { selectedCart.add(id); if (circle) circle.classList.add('checked'); }
            updateTotalAndButtons();
        }

        function toggleAllCart() {
            const grouped = {}; cart.forEach(id => grouped[id] = (grouped[id] || 0) + 1);
            const uniqueIds = Object.keys(grouped).map(Number);
            let shouldSelectAll = selectedCart.size !== uniqueIds.length || uniqueIds.length === 0;
            if(shouldSelectAll) uniqueIds.forEach(id => selectedCart.add(id)); else selectedCart.clear();
            uniqueIds.forEach(id => {
                const itemElement = document.getElementById('cart-item-' + id);
                const circle = itemElement ? itemElement.querySelector('.check-circle') : null;
                if (circle) shouldSelectAll ? circle.classList.add('checked') : circle.classList.remove('checked');
            });
            updateTotalAndButtons();
        }

        function deleteSelectedCart() {
            if(selectedCart.size === 0) return;
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?")) { cart = cart.filter(id => !selectedCart.has(id)); selectedCart.clear(); save(); renderCartList(); }
        }
        
        function updateCartQuantities() {
            const grouped = {}; cart.forEach(id => grouped[id] = (grouped[id] || 0) + 1);
            const ids = Object.keys(grouped).map(Number);
            const badge = document.getElementById('badge');
            badge.style.display = cart.length ? 'block' : 'none'; 
            if (badge.innerText != cart.length) { badge.innerText = cart.length; badge.style.animation = 'none'; badge.offsetHeight; badge.style.animation = 'pop 0.3s'; }
            ids.forEach(id => { const qtyValElement = document.querySelector(`#cart-item-${id} .qty-val`); if (qtyValElement) qtyValElement.innerText = grouped[id]; });
            const currentRows = document.getElementById('cart-items').children.length;
            if (currentRows !== ids.length) renderCartList(); else updateTotalAndButtons();
        }
        
        function renderCartList() {
            const grouped = {}; cart.forEach(id => grouped[id] = (grouped[id] || 0) + 1);
            const ids = Object.keys(grouped).map(Number);
            if (!ids.length) {
                document.getElementById('cart-items').innerHTML = '';
                document.getElementById('cart-empty').style.display = 'flex';
                document.getElementById('cart-footer').style.display = 'none';
                selectedCart.clear();
            } else {
                document.getElementById('cart-empty').style.display = 'none';
                document.getElementById('cart-footer').style.display = 'block';
                document.getElementById('cart-items').innerHTML = ids.map(id => {
                    const p = db.find(x => x.id == id);
                    const isChecked = selectedCart.has(id) ? 'checked' : '';
                    return `
                        <div class="list-row" id="cart-item-${id}">
                            <div class="check-circle ${isChecked}" onclick="toggleCartSelect(${id})">
                                <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                            </div>
                            <img src="${p.images[0]}" class="list-img">
                            <div style="flex:1; min-width: 0;" onclick="openModal(${id})">
                                <div class="cart-item-name">${p.name}</div>
                                <div class="cart-item-price">${p.price} ‚ÇΩ</div>
                            </div>
                            <div class="qty-ctrl">
                                <div class="qty-btn" onclick="removeOne(${p.id})">‚àí</div>
                                <div class="qty-val">${grouped[id]}</div>
                                <div class="qty-btn" onclick="addOne(${p.id})">+</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            updateCartQuantities(); 
        }

        function formatPhone(input) {
            let digits = input.value.replace(/\D/g, ''); const maxDigits = 11;
            if (digits.length > maxDigits) digits = digits.substring(0, maxDigits);
            let formatted = '';
            if (digits.length === 0) { input.value = ''; return; }
            if (digits.startsWith('8') || digits.startsWith('7')) digits = '7' + digits.substring(1);
            else if (digits.length > 1 && !digits.startsWith('7')) { digits = '7' + digits.substring(0, maxDigits); }
            if (digits.length > 0) formatted += '+7';
            if (digits.length > 1) { formatted += ' ('; formatted += digits.substring(1, 4); }
            if (digits.length > 4) { formatted += ') '; formatted += digits.substring(4, 7); }
            if (digits.length > 7) { formatted += '-'; formatted += digits.substring(7, 9); }
            if (digits.length > 9) { formatted += '-'; formatted += digits.substring(9, 11); }
            input.value = formatted;
        }

        const addressInput = document.getElementById('address-input');
        const suggestionsContainer = document.getElementById('address-suggestions');
        let debounceTimeout;
        if (addressInput) {
            addressInput.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                const query = addressInput.value.trim();
                if (query.length < 3) { suggestionsContainer.innerHTML = ''; return; }
                debounceTimeout = setTimeout(() => { fetchSuggestions(query); }, 300);
            });
            addressInput.addEventListener('blur', () => { setTimeout(() => { suggestionsContainer.innerHTML = ''; }, 150); });
        }

        async function fetchSuggestions(query) {
            if (DADATA_TOKEN === 'YOUR_DADATA_API_KEY') { suggestionsContainer.innerHTML = '<div class="suggestion-item" style="color:var(--red)">! –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á DaData API</div>'; return; }
            try {
                const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address", {
                    method: "POST", mode: "cors",
                    headers: { "Content-Type": "application/json", "Accept": "application/json", "Authorization": "Token " + DADATA_TOKEN },
                    body: JSON.stringify({ query: query, count: 5 })
                });
                const data = await response.json();
                renderSuggestions(data.suggestions);
            } catch (error) { suggestionsContainer.innerHTML = ''; }
        }

        function renderSuggestions(suggestions) {
            suggestionsContainer.innerHTML = ''; if (!suggestions || suggestions.length === 0) return;
            suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'suggestion-item'; div.textContent = s.value;
                
                // GEO LOGIC
                div.onclick = () => { 
                    addressInput.value = s.value; 
                    suggestionsContainer.innerHTML = ''; 
                    addressInput.blur();
                    const lat = parseFloat(s.data.geo_lat);
                    const lon = parseFloat(s.data.geo_lon);
                    const city = s.data.city || s.data.region;
                    const region = s.data.region_with_type || "";
                    
                    if (!isNaN(lat) && !isNaN(lon)) calculateDeliveryCost(lat, lon, city, region);
                    else {
                        document.getElementById('dd-price').innerText = "–£—Ç–æ—á–Ω–∏—Ç –º–µ–Ω–µ–¥–∂–µ—Ä";
                        document.getElementById('delivery-details-box').style.display = 'block';
                        globalDeliveryPrice = 0; updateCheckoutTotalUI();
                    }
                };
                suggestionsContainer.appendChild(div);
            });
        }
        
        function submitOrder() {
            try {
                const phoneInput = document.getElementById('phone-input');
                const address = document.getElementById('address-input').value.trim();
                const comment = document.getElementById('comment-input').value.trim();
                const rawPhoneDigits = phoneInput.value.replace(/\D/g, ''); 
                
                if (rawPhoneDigits.length !== 11) { tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"); phoneInput.focus(); return; }
                if (!address) { tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"); document.getElementById('address-input').focus(); return; }
                
                let deliveryTimeStr = "";
                if (isRegionalDelivery) {
                     if (!selectedDate) { tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏"); return; }
                     const dateStr = selectedDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long'});
                     deliveryTimeStr = "–û—Ç–ø—Ä–∞–≤–∫–∞ –°–î–≠–ö: " + dateStr;
                } else {
                     if (!selectedDate || !selectedTimeSlot) { tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ—Å—Ç–∞–≤–∫–∏"); return; }
                     const dateStr = selectedDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long'});
                     deliveryTimeStr = `${dateStr}, ${selectedTimeSlot}`;
                }

                const cartItemsForBot = []; const grouped = {}; 
                cart.filter(id => selectedCart.has(id)).forEach(id => { grouped[id] = (grouped[id] || 0) + 1; });
                Object.keys(grouped).forEach(id => { cartItemsForBot.push({ id: parseInt(id), qty: grouped[id] }); });
                
                const itemsText = Object.keys(grouped).map(id => { const product = db.find(x => x.id == id); return `${product.name} x${grouped[id]}`; }).join(', ');
                
                let productsTotal = checkoutTotalPrice;
                if(currentDiscount > 0) {
                    productsTotal = Math.floor(checkoutTotalPrice * (1 - currentDiscount));
                }
                const finalTotalWithDelivery = productsTotal + globalDeliveryPrice;
                const deliveryText = globalDeliveryPrice > 0 ? `–î–æ—Å—Ç–∞–≤–∫–∞: ${globalDeliveryPrice} ‚ÇΩ` : "–î–æ—Å—Ç–∞–≤–∫–∞: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ/–ë–µ—Å–ø–ª–∞—Ç–Ω–æ";

                const dataToSend = { 
                    action: "checkout", 
                    total: finalTotalWithDelivery, 
                    items_text: [itemsText + `\nüöö ${deliveryText}`], 
                    cart_items: cartItemsForBot, 
                    phone: phoneInput.value, 
                    address: address, 
                    comment: comment || "–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è",
                    delivery_time: deliveryTimeStr, 
                    promo_code: appliedPromoCode
                };
                
                if(appliedPromoCode === 'COTTON') {
                    localStorage.setItem('promo_used_v6', 'true');
                }

                cart = cart.filter(id => !selectedCart.has(id)); selectedCart.clear(); save(); renderCartList();
                tg.sendData(JSON.stringify(dataToSend)); 
                closeCheckoutModal();
            } catch (e) {
                tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö");
                console.error(e);
            }
        }
        
        function clearFav() { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?")) { favs = []; save(); render(); renderFavs(); } }

        function renderFavs() {
            const list = db.filter(p => favs.includes(p.id));
            const container = document.getElementById('fav-items');
            document.getElementById('fav-empty').style.display = list.length ? 'none' : 'flex';
            container.innerHTML = list.map(p => drawCard(p)).join('');
        }
        
        function openModal(id) {
            currentId = id; const p = db.find(x => x.id === id);
            const slides = p.images.map(url => `<div class="modal-slide"><img src="${url}" onclick="openLightbox('${url}')"></div>`).join('');
            const dots = p.images.map((_, i) => `<div class="modal-dot ${i===0?'active':''}"></div>`).join('');
            document.getElementById('m-slider').innerHTML = slides; document.getElementById('m-dots').innerHTML = dots;
            document.getElementById('m-title').innerText = p.name; document.getElementById('m-price').innerText = p.price + ' ‚ÇΩ'; document.getElementById('m-desc').innerText = p.desc;
            updateModalFavBtn(); 
            
            // RENDER PREMIUM FOOTER
            updateModalButtons(id);

            const modal = document.getElementById('modal'); modal.classList.add('modal-active');
            const slider = document.getElementById('m-slider');
            slider.onscroll = () => {
                const index = Math.round(slider.scrollLeft / slider.offsetWidth);
                const dotEls = document.querySelectorAll('.modal-dot');
                dotEls.forEach(d => d.classList.remove('active'));
                if(dotEls[index]) dotEls[index].classList.add('active');
            };
        }
        
        // --- NEW: PREMIUM MODAL LOGIC v14.0 ---
        function updateModalButtons(id) {
            const footer = document.getElementById('modal-footer');
            const qty = cart.filter(x => x === id).length;
            
            if (qty > 0) {
                footer.innerHTML = `
                    <button class="action-btn buy-now" onclick="buyNow(${id})">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    <div class="modal-qty-ctrl">
                        <div class="modal-qty-btn" onclick="removeOne(${id})">‚àí</div>
                        <div class="modal-qty-val">${qty}</div>
                        <div class="modal-qty-btn" onclick="addOne(${id})">+</div>
                    </div>
                `;
            } else {
                footer.innerHTML = `
                    <button class="action-btn buy-now" onclick="buyNow(${id})">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    <button class="action-btn add-cart" onclick="addOne(${id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                `;
            }
        }

        function buyNow(id) {
            // 1. Add if not in cart
            const inCart = cart.includes(id);
            if (!inCart) {
                addOne(id); 
            }
            
            // 2. Close Product Modal
            closeModal();
            
            // 3. Select this item specifically for checkout
            selectedCart.add(id);
            updateTotalAndButtons();
            
            // 4. Open Checkout
            setTimeout(() => {
                openCheckoutModal();
            }, 300);
        }

        function closeModal() { document.getElementById('modal').classList.remove('modal-active'); }
        function addCurrentToCart() { addOne(currentId); closeModal(); }

        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        let currentScale = 1; let initialDist = 0; let initialScale = 1;
        function openLightbox(src) { lightboxImg.src = src; lightbox.style.display = 'flex'; setTimeout(() => lightbox.classList.add('visible'), 10); currentScale = 1; lightboxImg.style.transform = `scale(1)`; }
        function closeLightbox() { lightbox.classList.remove('visible'); setTimeout(() => { lightbox.style.display = 'none'; }, 300); }
        lightbox.addEventListener('touchstart', (e) => { if (e.touches.length === 2) { initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); initialScale = currentScale; } });
        lightbox.addEventListener('touchmove', (e) => { if (e.touches.length === 2) { const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); const delta = dist / initialDist; currentScale = Math.min(Math.max(1, initialScale * delta), 4); lightboxImg.style.transform = `scale(${currentScale})`; e.preventDefault(); } });
        let touchStartY = 0; lightbox.addEventListener('touchstart', e => { if(e.touches.length===1) touchStartY = e.touches[0].clientY; });
        lightbox.addEventListener('touchend', e => { if (e.changedTouches.length === 1 && currentScale === 1) { const diff = e.changedTouches[0].clientY - touchStartY; if (Math.abs(diff) < 10) closeLightbox(); if (diff > 100) closeLightbox(); } });

        function go(id, btn) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.getElementById('p-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); btn.classList.add('active');
            if(id === 'fav') renderFavs(); if(id === 'cart') renderCartList(); if(id === 'home') render();
        }

        if(tg.initDataUnsafe?.user) {
            document.getElementById('u-name').innerText = tg.initDataUnsafe.user.first_name;
            if(tg.initDataUnsafe.user.photo_url) document.getElementById('u-ava').innerHTML = `<img src="${tg.initDataUnsafe.user.photo_url}" style="width:100%;height:100%;object-fit:cover">`;
        }

        function setupPTR(page) {
            const spinner = page.querySelector('.ptr-spinner');
            if(!spinner) return;
            let startY = 0;
            page.addEventListener('touchstart', e => { 
                if(page.scrollTop === 0) startY = e.touches[0].clientY; 
            }, { passive: false });
            page.addEventListener('touchmove', e => {
                const diff = e.touches[0].clientY - startY;
                if(diff > 0 && page.scrollTop <= 0) { 
                    if (e.cancelable) e.preventDefault();
                    if(diff < 80) spinner.style.height = diff + 'px'; 
                }
            }, { passive: false });
            page.addEventListener('touchend', e => {
                if(parseInt(spinner.style.height) > 60) { 
                    tg.HapticFeedback.impactOccurred('medium'); 
                    setTimeout(() => { 
                        if(page.id === 'p-home') render(); if(page.id === 'p-cart') renderCartList(); if(page.id === 'p-fav') renderFavs(); 
                        spinner.style.height = '0px'; 
                    }, 500); 
                } else { spinner.style.height = '0px'; }
            });
        }
        
        function createSnowflake() {
            const snowContainer = document.getElementById('snow-container');
            if(!snowContainer) return;
            const snow = document.createElement('div');
            snow.classList.add('snowflake');
            snow.innerText = '‚ùÑ';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = Math.random() * 3 + 4 + 's';
            snow.style.opacity = Math.random() * 0.7 + 0.3;
            snow.style.fontSize = Math.random() * 10 + 10 + 'px';
            snowContainer.appendChild(snow);
            setTimeout(() => { snow.remove(); }, 7000);
        }
        setInterval(createSnowflake, 300);

        function drawRealisticNobilis() {
            const canvas = document.getElementById('header-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.parentElement.offsetWidth;
            const h = canvas.parentElement.offsetHeight;
            canvas.width = w * 2; canvas.height = h * 2;
            canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
            ctx.scale(2, 2);

            ctx.clearRect(0, 0, w, h);

            const needlePalette = ['#1a2f23', '#2d4a3e', '#416b5a', '#6b9c8a', '#8fbdaf']; 

            function drawBranch(startX, startY, angle, length, width, depth) {
                if (depth === 0) return;
                const endX = startX + Math.cos(angle) * length;
                const endY = startY + Math.sin(angle) * length;
                const steps = length / 2;
                for (let i = 0; i < steps; i++) {
                    const t = i / steps;
                    const cx = startX + (endX - startX) * t;
                    const cy = startY + (endY - startY) * t;
                    for (let layer = 0; layer < 3; layer++) {
                        const needleAngle = angle + (Math.random() - 0.5) * 2.5;
                        const needleLen = 10 + Math.random() * 15;
                        const color = needlePalette[Math.floor(Math.random() * (layer + 2))];
                        ctx.beginPath();
                        ctx.moveTo(cx, cy);
                        ctx.lineTo(cx + Math.cos(needleAngle) * needleLen, cy + Math.sin(needleAngle) * needleLen);
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 1.5;
                        ctx.lineCap = 'round';
                        ctx.stroke();
                        if(layer === 2 && Math.random() > 0.7) {
                            ctx.beginPath();
                            const tipX = cx + Math.cos(needleAngle) * needleLen;
                            const tipY = cy + Math.sin(needleAngle) * needleLen;
                            ctx.moveTo(tipX - Math.cos(needleAngle)*3, tipY - Math.sin(needleAngle)*3);
                            ctx.lineTo(tipX, tipY);
                            ctx.strokeStyle = "rgba(255,255,255,0.6)";
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    }
                }
                if (depth > 1) {
                    const subBranches = 3;
                    for (let i = 0; i < subBranches; i++) {
                        const subAngle = angle + (Math.random() - 0.5) * 1.5;
                        const subLen = length * 0.6;
                        const pos = Math.random();
                        const sx = startX + (endX - startX) * pos;
                        const sy = startY + (endY - startY) * pos;
                        drawBranch(sx, sy, subAngle, subLen, width * 0.7, depth - 1);
                    }
                }
            }

            const mainY = h * 0.4;
            drawBranch(-20, mainY + 20, -0.2, w * 0.5, 4, 1);
            drawBranch(w, mainY + 30, 3.2, w * 0.6, 4, 1);
            drawBranch(-50, mainY, 0.1, w * 1.2, 5, 2);

            for(let i=0; i<w; i+=80) {
               drawBranch(i, mainY, 1.5, 60, 2, 1); 
               drawBranch(i + 40, mainY, -1.5, 40, 2, 1); 
            }
            
            for(let i=0; i<w; i+=30) {
                if(Math.random() > 0.3) continue;
                const ly = mainY + (Math.random()-0.5)*20;
                ctx.beginPath();
                ctx.arc(i, ly, 3, 0, Math.PI*2);
                ctx.fillStyle = Math.random() > 0.5 ? "#ffcc00" : "#ff4500"; 
                ctx.shadowBlur = 10;
                ctx.shadowColor = ctx.fillStyle;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            const ballColors = [{c: '#b8860b', s: '#ffd700'}, {c: '#8b0000', s: '#ff4500'}, {c: '#191970', s: '#4169e1'}];
            const numBalls = 5;
            for (let i = 0; i < numBalls; i++) {
                const x = (w / numBalls) * i + (w / numBalls) / 2 + (Math.random()-0.5)*30;
                const y = mainY + 15;
                const maxDrop = h - y - 15; 
                const drop = Math.min(15 + Math.random() * 20, maxDrop);
                const r = 8 + Math.random() * 4;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x, y + drop);
                ctx.strokeStyle = "rgba(255,255,255,0.5)";
                ctx.lineWidth = 1;
                ctx.stroke();
                const color = ballColors[Math.floor(Math.random() * ballColors.length)];
                const grad = ctx.createRadialGradient(x - r/3, y + drop - r/3, r/4, x, y + drop, r);
                grad.addColorStop(0, color.s);
                grad.addColorStop(1, color.c);
                ctx.beginPath();
                ctx.arc(x, y + drop, r, 0, Math.PI * 2);
                ctx.fillStyle = grad;
                ctx.shadowBlur = 5;
                ctx.shadowColor = color.s;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        window.addEventListener('load', drawRealisticNobilis);
        window.addEventListener('resize', drawRealisticNobilis);
        document.querySelectorAll('.page').forEach(page => setupPTR(page));
        render();
        updateCartQuantities();

        // ---------------------------------------------
        // NEW v12.0: MARKETPLACE EFFECT (STICKY + STATIC)
        // ---------------------------------------------
        const stickyFooter = document.getElementById('sticky-footer');
        const staticPayBlock = document.getElementById('static-pay-block');
        let initialHeight = window.innerHeight;

        // 1. KEYBOARD DISMISS ON TAP (OUTSIDE INPUTS)
        document.addEventListener('click', (e) => {
            const tag = e.target.tagName;
            // If click is NOT on an input/textarea/button, dismiss keyboard
            if (tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'BUTTON') {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
                    document.activeElement.blur();
                }
            }
        });

        // 2. KEYBOARD DETECTION (RESIZE)
        window.addEventListener('resize', () => {
            if (!stickyFooter) return;
            const currentHeight = window.innerHeight;
            
            if (currentHeight < initialHeight * 0.8) {
                stickyFooter.classList.add('hidden'); // Hide on keyboard open
            } else {
                // If keyboard closed, check scroll position to decide visibility
                checkScrollVisibility();
                if(currentHeight > initialHeight) initialHeight = currentHeight;
            }
        });

        // 3. INTERSECTION OBSERVER (HIDE STICKY WHEN STATIC IS VISIBLE)
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    stickyFooter.classList.add('hidden'); // Hide sticky when static is visible
                } else {
                    // Only show if keyboard is NOT open
                    if (window.innerHeight > initialHeight * 0.8) {
                        stickyFooter.classList.remove('hidden');
                    }
                }
            });
        }, { threshold: 0.1 });

        if(staticPayBlock) observer.observe(staticPayBlock);

        // Helper to re-check visibility manually
        function checkScrollVisibility() {
            if(!staticPayBlock) return;
            const rect = staticPayBlock.getBoundingClientRect();
            const isVisible = (rect.top >= 0) && (rect.bottom <= window.innerHeight);
            if (!isVisible) stickyFooter.classList.remove('hidden');
        }
    </script>
</body>
</html>
