<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flower Smart Select</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* --- –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê --- */
            --bg: #000000;
            --block: #1C1C1E;
            --text: #FFFFFF;
            --text-sec: #8E8E93;
            --input-bg: #2C2C2E;
            --accent: #E75A7C;
            --green: #32D74B;
            --red: #FF453A;
            --nav-bg: rgba(28, 28, 30, 0.95);
            --border: rgba(255,255,255,0.1);
        }

        body.light-theme {
            --bg: #F2F2F7;
            --block: #FFFFFF;
            --text: #000000;
            --text-sec: #8E8E93;
            --input-bg: #E5E5EA;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --border: rgba(0,0,0,0.1);
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 85px;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none;
            transition: background 0.3s;
            touch-action: pan-y; /* V1.2: –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π */
        }
        
        /* V1.2: –ö–ª–∞—Å—Å –¥–ª—è –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        img { -webkit-touch-callout: none; -webkit-user-drag: none; pointer-events: auto; }

        /* –ß–ï–ö–ë–û–ö–° (–ö–†–£–ñ–û–ö –í–´–ë–û–†–ê) */
        .check-circle {
            width: 22px; height: 22px;
            border: 2px solid var(--text-sec);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0;
            cursor: pointer;
        }
        .check-circle.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .check-circle::after {
            content: '‚úî'; color: white; font-size: 14px; opacity: 0; transform: scale(0.5); transition: 0.2s;
        }
        .check-circle.checked::after { opacity: 1; transform: scale(1); }

        /* –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –í–´–ë–†–ê–ù–ù–û–ì–û */
        .del-selected-btn {
            background: rgba(255, 69, 58, 0.1); color: var(--red);
            border: 1px solid var(--red); padding: 8px 15px; border-radius: 20px;
            font-size: 13px; font-weight: 600; display: none;
            align-items: center; gap: 5px; cursor: pointer;
        }
        /* –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ" –¥–ª—è –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ */
        .del-all-fav-btn {
            color: var(--red); font-size: 14px; background: none; border: none; cursor: pointer;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 50% { transform: scale(1.2); } }

        /* –®–ê–ü–ö–ê */
        header {
            position: sticky; top: 0; background: var(--nav-bg);
            backdrop-filter: blur(20px); z-index: 20; padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        .logo-icon { width: 32px; height: 32px; fill: var(--accent); }
        .brand { font-weight: 700; font-size: 19px; letter-spacing: 0.5px; color: var(--text); }

        /* –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í */
        .search-wrap { padding: 12px 16px; }
        .search-input {
            width: 100%; padding: 10px 12px; border-radius: 10px; border: none;
            background: var(--input-bg); color: var(--text); font-size: 15px; outline: none;
            box-sizing: border-box;
        }
        .grid { display: grid; gap: 12px; padding: 0 16px; grid-template-columns: 1fr 1fr; }
        @media (min-width: 600px) { .grid { grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); } }
        
        .card { 
            background: var(--block); border-radius: 14px; overflow: hidden; position: relative; 
            animation: fadeUp 0.4s backwards; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .card:active { transform: scale(0.97); transition: 0.1s; }

        .slider-wrapper { position: relative; width: 100%; height: 170px; overflow: hidden; }
        .slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 100%; scrollbar-width: none; }
        .slider::-webkit-scrollbar { display: none; }
        .slide { min-width: 100%; height: 100%; scroll-snap-align: center; }
        .slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .dots { position: absolute; bottom: 8px; left: 0; width: 100%; display: flex; justify-content: center; gap: 4px; pointer-events: none; }
        .dot { width: 4px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 50%; }

        .fav-btn {
            position: absolute; top: 8px; right: 8px; width: 30px; height: 30px;
            background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(5px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5;
        }
        .light-theme .fav-btn { background: rgba(255,255,255,0.8); }
        .fav-icon-svg { width: 18px; height: 18px; fill: none; stroke: #fff; stroke-width: 2; }
        .light-theme .fav-icon-svg { stroke: #333; }
        .fav-btn.is-active .fav-icon-svg { fill: var(--red); stroke: var(--red); }
        .fav-btn.active-anim { animation: pop 0.3s ease; }

        .cart-btn {
            position: absolute; bottom: 10px; right: 10px; width: 34px; height: 34px;
            background: var(--accent); color: white; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5;
        }
        .cart-btn:active { transform: scale(0.9); background: var(--green); }
        .cart-icon-svg { width: 18px; height: 18px; fill: white; }

        .info { padding: 10px; padding-right: 45px; }
        .name { font-weight: 500; font-size: 13px; margin-bottom: 4px; height: 32px; line-height: 1.25; overflow: hidden; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price { font-weight: 700; font-size: 14px; color: var(--text); }

        /* –°–¢–†–û–ö–ê –¢–û–í–ê–†–ê (–ö–û–†–ó–ò–ù–ê) */
        .list-row { 
            display: flex; align-items: center; gap: 12px; 
            background: var(--block); padding: 10px; margin: 10px 16px; border-radius: 12px; 
            animation: fadeUp 0.3s;
        }
        .list-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        
        /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –í–´–†–ê–í–ù–ò–í–ê–ù–ò–Ø –¢–ï–ö–°–¢–ê –í –ö–û–†–ó–ò–ù–ï */
        .cart-item-name {
            font-weight: 500;
            font-size: 13px;
            line-height: 1.3;
            overflow: hidden;
            /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏–º—è 2 —Å—Ç—Ä–æ–∫–∞–º–∏, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –Ω–µ –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ–π */
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
        }
        .cart-item-price {
            color: var(--text-sec);
            font-size: 13px;
            margin-top: 2px;
        }
        
        .qty-ctrl { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 4px; border-radius: 8px; margin-top: 5px; width: fit-content; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--bg); color: var(--text); border-radius: 6px; font-weight: bold; cursor: pointer; }
        .qty-val { font-weight: 600; min-width: 16px; text-align: center; font-size: 14px; color: var(--text); }

        /* –ú–ï–ù–Æ */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 56px;
            background: var(--nav-bg); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #636366; background: none; border: none; cursor: pointer; width: 25%; height: 100%; transition: color 0.2s; }
        .nav-icon { width: 22px; height: 22px; margin-bottom: 3px; fill: #636366; transition: fill 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active .nav-icon { fill: var(--accent); }
        .badge { position: absolute; top: 4px; margin-left: 14px; background: var(--red); color: white; font-size: 9px; font-weight: bold; padding: 1px 5px; border-radius: 8px; display: none; animation: pop 0.3s; }

        /* –ú–û–î–ê–õ–ö–ò */
        #modal, #settings-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg); z-index: 100; overflow-y: auto; 
            touch-action: pan-y; /* V1.2: –°–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–æ–∫ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π */
        }
        .modal-active { display: block !important; animation: fadeUp 0.3s; }
        .modal-slider-wrap { width: 100%; height: 380px; overflow: hidden; position: relative; }
        .modal-content { padding: 24px 20px; max-width: 600px; margin: 0 auto; background: var(--bg); min-height: 300px; border-radius: 20px 20px 0 0; position: relative; top: -20px; }
        .back-btn { position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; }
        .back-icon-svg { width: 24px; height: 24px; fill: white; }
        
        .fav-text-btn { width: 100%; padding: 14px; background: var(--block); border: 1px solid var(--border); color: var(--text); border-radius: 12px; font-size: 15px; font-weight: 600; margin-top: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .fav-text-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(231, 90, 124, 0.1); }
        .big-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; margin-top: 12px; cursor: pointer; box-shadow: 0 5px 15px rgba(231, 90, 124, 0.3); }
        .big-btn:disabled { background: var(--input-bg); color: var(--text-sec); box-shadow: none; cursor: not-allowed; }

        /* –ó–ê–ì–û–õ–û–í–ö–ò –í–ö–õ–ê–î–û–ö */
        .head-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-top: 15px; margin-bottom: 10px; }
        .head-title { font-size: 20px; font-weight: 800; margin: 0; }
        .sel-all-btn { color: var(--accent); font-size: 14px; background: none; border: none; cursor: pointer; }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--block); margin-bottom: 1px; cursor: pointer; }
        .settings-item:first-child { border-radius: 14px 14px 0 0; }
        .settings-item:last-child { border-radius: 0 0 14px 14px; }
        .settings-icon { margin-right: 10px; font-size: 18px; }
        .settings-arrow { color: var(--text-sec); font-size: 14px; }
        .toggle-switch { position: relative; width: 50px; height: 30px; }
        .toggle-input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #39393D; transition: .4s; border-radius: 34px; }
        .light-theme .toggle-slider { background-color: #E9E9EA; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-input:checked + .toggle-slider { background-color: var(--green); }
        .toggle-input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* –°–¢–†–ê–ù–ò–¶–´ –ò PTR */
        .app-container { touch-action: pan-y; } /* V1.2: –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Å–≤–∞–π–ø–µ */
        .page { 
            display: none; 
            /* –í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å calc(100vh - header - nav), —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª–∏–ª—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç, 
               —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è PTR –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö. */
            height: calc(100vh - 56px - env(safe-area-inset-bottom)); 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; /* –î–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ iOS */
        }
        #modal .page, #settings-modal .page { height: 100vh; } /* –ü–æ–ª–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –º–æ–¥–∞–ª–æ–∫ */
        .page.active { display: block; }
        .empty-state { text-align: center; color: var(--text-sec); margin-top: 60px; font-size: 14px;}
        /* –û–ë–©–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –í–°–ï–• PTR –°–ü–ò–ù–ù–ï–†–û–í */
        .ptr-spinner-all { height: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; transition: height 0.2s; background: var(--bg); flex-shrink: 0; }
        #ptr-spinner { /* –î–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã home, –≥–¥–µ –æ–Ω –æ–¥–∏–Ω */
            height: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; transition: height 0.2s; background: var(--bg); flex-shrink: 0;
        }
        .ptr-icon { width: 20px; height: 20px; border: 2px solid var(--border); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <svg class="logo-icon" viewBox="0 0 512 512"><path d="M256 64c-50 0-94 28-118 70 0 0-14 0-14 0 -50 0-90 40-90 90 0 45 33 82 76 89 5 42 42 75 86 75 24 0 46-9 62-25 16 16 38 25 62 25 44 0 81-33 86-75 43-7 76-44 76-89 0-50-40-90-90-90 0 0-14 0-14 0C350 92 306 64 256 64z" fill="currentColor"/></svg>
            <div class="brand">Cotton Flowers</div>
        </header>

        <div id="p-home" class="page active">
            <div id="ptr-spinner"><div class="ptr-icon"></div></div>
            <div class="search-wrap">
                <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="doSearch(this.value)">
            </div>
            <div class="grid" id="grid"></div>
        </div>

        <div id="p-cart" class="page">
            <div id="ptr-spinner-cart" class="ptr-spinner-all"><div class="ptr-icon"></div></div>
            <div class="head-row">
                <h2 class="head-title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <div style="display:flex; gap:15px">
                    <button class="del-selected-btn" id="cart-del-btn" onclick="deleteSelectedCart()">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    <button class="sel-all-btn" onclick="toggleAllCart()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                </div>
            </div>
            <div id="cart-items"></div>
            <div class="empty-state" id="cart-empty" style="display:none">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üçÉ</div>
            <div id="cart-footer" style="padding: 15px; max-width: 600px; margin: 0 auto; flex-shrink: 0;">
                <div style="text-align: right; font-weight: 600; font-size: 18px; margin-bottom: 15px;">
                    –ò—Ç–æ–≥–æ (–≤—ã–±—Ä–∞–Ω–æ): <span id="total-price" style="color: var(--accent)">0</span> ‚ÇΩ
                </div>
                <button class="big-btn" id="checkout-btn" onclick="checkout()" disabled>–û–§–û–†–ú–ò–¢–¨ –í–´–ë–†–ê–ù–ù–û–ï</button>
            </div>
        </div>

        <div id="p-fav" class="page">
            <div id="ptr-spinner-fav" class="ptr-spinner-all"><div class="ptr-icon"></div></div>
            <div class="head-row">
                <h2 class="head-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
                <div style="display:flex; gap:15px">
                    <button class="del-all-fav-btn" onclick="clearFav()">üóë –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
                </div>
            </div>
            <div class="grid" id="fav-items"></div>
            <div class="empty-state" id="fav-empty" style="display:none">–ù–µ—Ç –ª—é–±–∏–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ üíî</div>
        </div>

        <div id="p-prof" class="page">
            <div id="ptr-spinner-prof" class="ptr-spinner-all"><div class="ptr-icon"></div></div>
            <div style="text-align: center; padding: 40px 20px;">
                <div style="width: 80px; height: 80px; background: var(--block); border-radius: 50%; margin: 0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:40px; border: 2px solid var(--border);" id="u-ava">üë§</div>
                <h2 id="u-name" style="margin: 0; font-size: 20px;">–ì–æ—Å—Ç—å</h2>
            </div>
            <div style="padding: 0 16px; max-width: 600px; margin: 0 auto; flex-shrink: 0;">
                <div class="settings-item" onclick="openSupport()">
                    <div style="display:flex; align-items:center"><span class="settings-icon">üí¨</span> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                    <div class="settings-arrow">·ê≥</div>
                </div>
                <div class="settings-item" onclick="openSettings()">
                    <div style="display:flex; align-items:center"><span class="settings-icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="settings-arrow">·ê≥</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="back-btn" onclick="closeModal()">
            <svg class="back-icon-svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </div>
        <div class="modal-slider-wrap"><div class="modal-slider" id="m-slider"></div></div>
        <div class="modal-content">
            <h1 id="m-title" style="margin: 0; font-size: 22px; line-height: 1.2;"></h1>
            <div id="m-price" style="font-size: 24px; font-weight: 700; color: var(--accent); margin: 8px 0;"></div>
            <p id="m-desc" style="line-height: 1.6; color: var(--text-sec); margin-bottom: 25px; font-size: 15px;"></p>
            <button class="fav-text-btn" id="m-fav-btn" onclick="toggleModalFav()">ü§ç –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button class="big-btn" onclick="addCurrentToCart()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </div>

    <div id="settings-modal">
        <div style="padding: 20px;">
            <div style="display:flex; align-items:center; margin-bottom: 20px;">
                <div class="back-btn" style="position:static; margin-right:15px; background:var(--block);" onclick="closeSettings()">
                    <svg class="back-icon-svg" style="fill:var(--text)" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </div>
                <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div style="background: var(--block); border-radius: 14px; overflow:hidden;">
                <div class="settings-item" style="cursor:default">
                    <div style="display:flex; align-items:center"><span class="settings-icon">üåì</span> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</div>
                    <label class="toggle-switch">
                        <input type="checkbox" class="toggle-input" id="theme-toggle" onchange="toggleTheme()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item" style="cursor:default">
                    <div style="display:flex; align-items:center"><span class="settings-icon">üåê</span> –Ø–∑—ã–∫ (EN)</div>
                    <label class="toggle-switch">
                        <input type="checkbox" class="toggle-input" id="lang-toggle" onchange="toggleLang()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <nav>
        <button class="nav-item active" onclick="go('home', this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span class="nav-text">–ö–∞—Ç–∞–ª–æ–≥</span>
        </button>
        <button class="nav-item" style="position:relative" onclick="go('cart', this)">
            <span class="badge" id="badge">0</span>
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16.53 11.06L15.45 13H9.55l-1.08-1.94c-.16-.28-.25-.61-.25-.96 0-1.1.9-2 2-2h3.58l-3.5-6.06L12 1.34l4.23 7.37C16.66 9.08 16.75 9.53 16.53 11.06zM7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM17 18c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zM4.05 13h15.9l-.94 2H5.21l-1.16-2z"/></svg>
            <span class="nav-text">–ö–æ—Ä–∑–∏–Ω–∞</span>
        </button>
        <button class="nav-item" onclick="go('fav', this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>
            <span class="nav-text">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </button>
        <button class="nav-item" onclick="go('prof', this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span class="nav-text">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const SUPPORT_USERNAME = 'DUROV';
        let currentModalItem = null;
        let userCart = JSON.parse(localStorage.getItem('userCart') || '[]');
        let userFav = JSON.parse(localStorage.getItem('userFav') || '[]');

        const db = [
            { id: 1, name: "–ì–µ–ª–∏—Ö—Ä–∏–∑—É–º —Å–æ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–æ–∑–æ–π –ö–∞–ø–ø—É—á–∏–Ω–æ", price: 1500, desc: "–°–æ—Å—Ç–∞–≤: –†–æ–∑–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - 1 —à—Ç. –ì—É–±–∫–∞ —Ñ–ª–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è - 1 —à—Ç. –ü–∞–º–ø–∞—Å–Ω–∞—è —Ç—Ä–∞–≤–∞ - 1 —à—Ç. –§–∞–ª–∞—Ä–∏—Å —Å—É—Ö–æ—Ü–≤–µ—Ç - 3 —à—Ç. –û—Ç–ª–∏—á–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –Ω–∞ –ª—é–±–æ–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ –∑–Ω–∞–∫ –≤–Ω–∏–º–∞–Ω–∏—è. –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É—Ö–æ–¥–∞ –∏ –±—É–¥–µ—Ç —Ä–∞–¥–æ–≤–∞—Ç—å –≥–ª–∞–∑ –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/71/1759415719_47099271.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/48/1759415735_22242048.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/75/1759415738_10207875.jpg"] },
            { id: 2, name: "–•–ª–æ–ø–æ–∫ –∏ –õ–∞–≤–∞–Ω–¥–∞ –≤ –º–µ—à–æ—á–∫–µ", price: 1200, desc: "–ö–æ–º–ø–æ–∑–∏—Ü–∏—è –∏–∑ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–ª–æ–ø–∫–∞, –∞—Ä–æ–º–∞—Ç–Ω–æ–π –ª–∞–≤–∞–Ω–¥—ã –∏ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –≤–µ—Ç–æ—á–µ–∫ –≤ –ª—å–Ω—è–Ω–æ–º –º–µ—à–æ—á–∫–µ. –°–æ–∑–¥–∞—Å—Ç —É—é—Ç –∏ –Ω–∞–ø–æ–ª–Ω–∏—Ç –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏—è—Ç–Ω—ã–º –∑–∞–ø–∞—Ö–æ–º. –°–æ—Å—Ç–∞–≤: –•–ª–æ–ø–æ–∫ - 3 —à—Ç., –õ–∞–≤–∞–Ω–¥–∞ - 1 –ø—É—á–æ–∫, –ú–µ—à–æ—á–µ–∫ –ª—å–Ω—è–Ω–æ–π - 1 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/49/1660124749_73223049.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/60/1660124760_89350460.jpg"] },
            { id: 3, name: "–ù–µ–∂–Ω—ã–µ —Å—É—Ö–æ—Ü–≤–µ—Ç—ã –≤ –∫—Ä–∞—Ñ—Ç–µ", price: 1100, desc: "–ú–∏–Ω–∏-–±—É–∫–µ—Ç –∏–∑ –Ω–µ–∂–Ω—ã—Ö —Å—É—Ö–æ—Ü–≤–µ—Ç–æ–≤ (–∫–µ—Ä–º–µ–∫, —Å—Ç–∞—Ç–∏—Ü–∞) –≤ –∫—Ä–∞—Ñ—Ç–æ–≤–æ–π —É–ø–∞–∫–æ–≤–∫–µ. –û—Ç–ª–∏—á–Ω—ã–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç. –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞ –º–æ–∂–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ñ–æ—Ç–æ.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/18/1660124718_97746518.jpg"] },
            { id: 4, name: "–ë—É–∫–µ—Ç '–¶–∏—Ç—Ä—É—Å–æ–≤—ã–π –°–æ—Ä–±–µ—Ç'", price: 2800, desc: "–Ø—Ä–∫–∏–π –±—É–∫–µ—Ç –∏–∑ –∞—Ä–æ–º–∞—Ç–Ω—ã—Ö —Ü–∏—Ç—Ä—É—Å–æ–≤—ã—Ö —Ä–æ–∑, —ç—É—Å—Ç–æ–º—ã –∏ –∑–µ–ª–µ–Ω–∏. –°–æ—á–Ω—ã–π –∏ –ø–æ–¥–Ω–∏–º–∞—é—â–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. –°–æ—Å—Ç–∞–≤: –†–æ–∑–∞ - 7 —à—Ç., –≠—É—Å—Ç–æ–º–∞ - 4 —à—Ç., –≠–≤–∫–∞–ª–∏–ø—Ç - 3 –≤–µ—Ç–∫–∏.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/69/1684578569_51478769.jpg", "https://content2.flowwow-images.com/data/flowers/1000x1000/98/1684578598_10010098.jpg"] },
            { id: 5, name: "–ö–æ–º–ø–æ–∑–∏—Ü–∏—è '–§–ª–∞–º–∏–Ω–≥–æ'", price: 3500, desc: "–≠–∫–∑–æ—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤ —à–ª—è–ø–Ω–æ–π –∫–æ—Ä–æ–±–∫–µ —Å –ø—Ä–æ—Ç–µ–µ–π, –æ—Ä—Ö–∏–¥–µ–µ–π –∏ —Ä–æ–∑–æ–π. –î–ª—è —Å–∞–º—ã—Ö —Å–º–µ–ª—ã—Ö –∏ —è—Ä–∫–∏—Ö.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/52/1655026952_44901352.jpg"] },
            { id: 6, name: "–ú–æ–Ω–æ–±—É–∫–µ—Ç –∏–∑ 25 —Ç—é–ª—å–ø–∞–Ω–æ–≤", price: 3200, desc: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤–µ—Å–µ–Ω–Ω–∏–π –º–æ–Ω–æ–±—É–∫–µ—Ç –∏–∑ 25 –æ—Ç–±–æ—Ä–Ω—ã—Ö —Ç—é–ª—å–ø–∞–Ω–æ–≤. –¶–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä: –∫—Ä–∞—Å–Ω—ã–π, –±–µ–ª—ã–π, –∂–µ–ª—Ç—ã–π.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/77/1699564877_43806177.jpg"] },
            { id: 7, name: "–ö–æ—Ä–æ–±–∫–∞ —Å –ø–∏–æ–Ω–∞–º–∏ –∏ –º–∞–∫–∞—Ä—É–Ω–∞–º–∏", price: 4100, desc: "–ü–æ–¥–∞—Ä–æ—á–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞ —Å –∞—Ä–æ–º–∞—Ç–Ω—ã–º–∏ –ø–∏–æ–Ω–∞–º–∏ –∏ –Ω–∞–±–æ—Ä–æ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏—Ö –º–∞–∫–∞—Ä—É–Ω–æ–≤. –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –¥–ª—è —Å–ª–∞–¥–∫–æ–µ–∂–µ–∫. –í —Å–æ—Å—Ç–∞–≤–µ: –ü–∏–æ–Ω—ã - 5 —à—Ç., –ú–∞–∫–∞—Ä—É–Ω—ã - 5 —à—Ç.", images: ["https://content2.flowwow-images.com/data/flowers/1000x1000/76/1668078576_21817476.jpg"] },
        ];

        // --- –£–¢–ò–õ–ò–¢–´ ---

        function formatPrice(price) {
            return price.toLocaleString('ru-RU');
        }

        function saveCart() {
            localStorage.setItem('userCart', JSON.stringify(userCart));
            updateBadge();
        }
        
        function saveFav() {
            localStorage.setItem('userFav', JSON.stringify(userFav));
        }

        // --- UI –õ–û–ì–ò–ö–ê ---

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            tg.is2022() && tg.setBgColor(isLight ? '#F2F2F7' : '#000000');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        
        function updateBadge() {
            const badge = document.getElementById('badge');
            const totalQty = userCart.reduce((sum, item) => sum + item.qty, 0);
            badge.innerText = totalQty;
            badge.style.display = totalQty > 0 ? 'block' : 'none';
        }

        function go(pageId, navItem) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('p-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            navItem.classList.add('active');

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            if (pageId === 'fav') renderFav();
            else if (pageId === 'cart') renderCart();
        }

        function openModal(item) {
            currentModalItem = item;
            document.getElementById('m-title').innerText = item.name;
            document.getElementById('m-price').innerText = formatPrice(item.price) + ' ‚ÇΩ';
            document.getElementById('m-desc').innerText = item.desc;
            
            const isFav = userFav.includes(item.id);
            const favBtn = document.getElementById('m-fav-btn');
            favBtn.classList.toggle('active', isFav);
            favBtn.innerHTML = isFav ? '‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : 'ü§ç –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';

            renderSlider(item.images);
            document.getElementById('modal').classList.add('modal-active');
            document.body.classList.add('no-scroll'); // V1.2: –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('modal-active');
            document.body.classList.remove('no-scroll'); // V1.2: –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å
        }

        function renderSlider(images) {
            const sliderEl = document.getElementById('m-slider');
            sliderEl.innerHTML = '';
            const dotsEl = document.createElement('div');
            dotsEl.className = 'dots';

            images.forEach((src, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.innerHTML = `<img src="${src}" alt="–¶–≤–µ—Ç–æ–∫ ${index + 1}">`;
                sliderEl.appendChild(slide);

                const dot = document.createElement('span');
                dot.className = 'dot';
                if (index === 0) dot.style.background = 'white';
                dotsEl.appendChild(dot);
            });

            document.querySelector('.modal-slider-wrap').appendChild(dotsEl);

            sliderEl.addEventListener('scroll', () => {
                const index = Math.round(sliderEl.scrollLeft / sliderEl.offsetWidth);
                dotsEl.querySelectorAll('.dot').forEach((dot, i) => {
                    dot.style.background = i === index ? 'white' : 'rgba(255,255,255,0.5)';
                });
            });
        }
        
        function doSearch(query) {
            render(query.toLowerCase());
        }

        // --- –†–ï–ù–î–ï–† –§–£–ù–ö–¶–ò–ò ---

        function renderCard(item, containerId) {
            const container = document.getElementById(containerId);
            const isFav = userFav.includes(item.id);
            const inCart = userCart.find(c => c.id === item.id);
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${Math.random() * 0.2}s`;
            card.innerHTML = `
                <div class="slider-wrapper">
                    <div class="slider" onclick="openModal(${item.id})">
                        <div class="slide"><img src="${item.images[0]}" alt="${item.name}"></div>
                        ${item.images[1] ? `<div class="slide"><img src="${item.images[1]}" alt="${item.name}"></div>` : ''}
                    </div>
                    <div class="dots">
                        <span class="dot" style="background:white;"></span>
                        ${item.images[1] ? '<span class="dot"></span>' : ''}
                    </div>
                </div>
                <button class="fav-btn ${isFav ? 'is-active' : ''}" onclick="event.stopPropagation(); toggleFav(${item.id}, this)">
                    <svg class="fav-icon-svg" viewBox="0 0 24 24"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3z"/></svg>
                </button>
                <div class="info" onclick="openModal(${item.id})">
                    <div class="name">${item.name}</div>
                    <div class="price">${formatPrice(item.price)} ‚ÇΩ</div>
                </div>
                <button class="cart-btn" onclick="event.stopPropagation(); toggleCart(${item.id}, this, ${item.price}, '${item.name.replace(/'/g, "\\'")}', '${item.images[0].replace(/'/g, "\\'")}')">
                    <svg class="cart-icon-svg" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM17 18c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zM4.05 13h15.9l-.94 2H5.21l-1.16-2zM16.53 11.06L15.45 13H9.55l-1.08-1.94c-.16-.28-.25-.61-.25-.96 0-1.1.9-2 2-2h3.58l-3.5-6.06L12 1.34l4.23 7.37C16.66 9.08 16.75 9.53 16.53 11.06z"/></svg>
                </button>
            `;

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∏–ª—è –¥–ª—è –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –Ω–µ–π
            const cartButton = card.querySelector('.cart-btn');
            if (inCart) {
                cartButton.style.backgroundColor = 'var(--green)';
                cartButton.style.transform = 'scale(0.9)'; // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç "–¥–æ–±–∞–≤–ª–µ–Ω–æ"
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
            const slider = card.querySelector('.slider');
            const dots = card.querySelector('.dots');
            if (slider) {
                slider.addEventListener('scroll', (e) => {
                    e.stopPropagation(); // –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª —Å–ª–∞–π–¥–µ—Ä–∞ –Ω–µ –≤–ª–∏—è–ª –Ω–∞ —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    const index = Math.round(slider.scrollLeft / slider.offsetWidth);
                    dots.querySelectorAll('.dot').forEach((dot, i) => {
                        dot.style.background = i === index ? 'white' : 'rgba(255,255,255,0.5)';
                    });
                });
            }

            container.appendChild(card);
        }

        function renderCartItem(item) {
            const isChecked = item.selected !== false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é true
            const row = document.createElement('div');
            row.className = 'list-row';
            row.setAttribute('data-id', item.id);
            row.innerHTML = `
                <div class="check-circle ${isChecked ? 'checked' : ''}" onclick="toggleCartItemSelection(${item.id})"></div>
                <img src="${item.img}" class="list-img" alt="${item.name}">
                <div style="flex-grow: 1;">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">${formatPrice(item.price)} ‚ÇΩ</div>
                </div>
                <div class="qty-ctrl">
                    <button class="qty-btn" onclick="updateCartQuantity(${item.id}, -1)">-</button>
                    <span class="qty-val">${item.qty}</span>
                    <button class="qty-btn" onclick="updateCartQuantity(${item.id}, 1)">+</button>
                </div>
            `;
            return row;
        }

        function render(query = '') {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const filteredDb = db.filter(item => 
                item.name.toLowerCase().includes(query) || 
                item.desc.toLowerCase().includes(query)
            );

            if (filteredDb.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ü§∑‚Äç‚ôÄÔ∏è</div>`;
            } else {
                filteredDb.forEach(item => renderCard(item, 'grid'));
            }
        }
        
        function renderFav() {
            const container = document.getElementById('fav-items');
            const empty = document.getElementById('fav-empty');
            container.innerHTML = '';
            
            const favItems = db.filter(item => userFav.includes(item.id));
            
            if (favItems.length === 0) {
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                favItems.forEach(item => renderCard(item, 'fav-items'));
            }
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const empty = document.getElementById('cart-empty');
            const footer = document.getElementById('cart-footer');
            const totalPriceEl = document.getElementById('total-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            const delBtn = document.getElementById('cart-del-btn');

            container.innerHTML = '';

            if (userCart.length === 0) {
                empty.style.display = 'block';
                footer.style.display = 'none';
                delBtn.style.display = 'none';
                checkoutBtn.disabled = true;
                return;
            }

            empty.style.display = 'none';
            footer.style.display = 'block';
            
            let totalSelectedPrice = 0;
            let totalSelectedCount = 0;
            let allSelected = true;

            userCart.forEach(item => {
                const itemEl = renderCartItem(item);
                container.appendChild(itemEl);
                
                if (item.selected !== false) {
                    totalSelectedPrice += item.price * item.qty;
                    totalSelectedCount++;
                } else {
                    allSelected = false;
                }
            });

            totalPriceEl.innerText = formatPrice(totalSelectedPrice);
            checkoutBtn.disabled = totalSelectedPrice === 0;
            delBtn.style.display = totalSelectedCount > 0 ? 'flex' : 'none';

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            document.querySelector('#p-cart .sel-all-btn').innerText = allSelected && userCart.length > 0 ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
        }

        // --- –î–ï–ô–°–¢–í–ò–Ø ---
        
        function toggleFav(id, buttonEl) {
            const index = userFav.indexOf(id);
            if (index > -1) {
                userFav.splice(index, 1);
                buttonEl.classList.remove('is-active');
            } else {
                userFav.push(id);
                buttonEl.classList.add('is-active', 'active-anim');
                buttonEl.addEventListener('animationend', () => buttonEl.classList.remove('active-anim'), { once: true });
            }
            saveFav();
            renderFav(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –µ—Å–ª–∏ –º—ã –Ω–∞ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
        }
        
        function toggleModalFav() {
            const id = currentModalItem.id;
            const favBtn = document.getElementById('m-fav-btn');
            const index = userFav.indexOf(id);
            
            if (index > -1) {
                userFav.splice(index, 1);
                favBtn.classList.remove('active');
                favBtn.innerHTML = 'ü§ç –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
            } else {
                userFav.push(id);
                favBtn.classList.add('active');
                favBtn.innerHTML = '‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º';
            }
            saveFav();
            render(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–¥–µ—á–µ–∫
            renderFav();
        }

        function toggleCart(id, buttonEl, price, name, img) {
            const existingItem = userCart.find(item => item.id === id);
            
            if (existingItem) {
                // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ, —É–¥–∞–ª—è–µ–º –µ–≥–æ
                userCart = userCart.filter(item => item.id !== id);
                buttonEl.style.backgroundColor = 'var(--accent)';
                buttonEl.style.transform = 'scale(1)';
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
                userCart.push({ id, price, name, img, qty: 1, selected: true });
                buttonEl.style.backgroundColor = 'var(--green)';
                buttonEl.style.transform = 'scale(0.9)';
            }
            saveCart();
            renderCart();
        }
        
        function addCurrentToCart() {
            if (!currentModalItem) return;
            const id = currentModalItem.id;
            const price = currentModalItem.price;
            const name = currentModalItem.name;
            const img = currentModalItem.images[0];
            
            const existingItem = userCart.find(item => item.id === id);

            if (existingItem) {
                existingItem.qty += 1;
            } else {
                userCart.push({ id, price, name, img, qty: 1, selected: true });
            }
            
            closeModal();
            saveCart();
            renderCart();
            tg.HapticFeedback.notificationOccurred('success');
            tg.showPopup({ message: `${name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!` });
        }
        
        function updateCartQuantity(id, change) {
            const item = userCart.find(i => i.id === id);
            if (item) {
                item.qty += change;
                if (item.qty <= 0) {
                    userCart = userCart.filter(i => i.id !== id);
                }
                saveCart();
                renderCart();
                render(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –∫–æ—Ä–∑–∏–Ω—ã
            }
        }

        function toggleCartItemSelection(id) {
            const item = userCart.find(i => i.id === id);
            if (item) {
                item.selected = item.selected === false ? true : false;
                saveCart();
                renderCart();
            }
        }
        
        function deleteSelectedCart() {
            userCart = userCart.filter(item => item.selected === false);
            saveCart();
            renderCart();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function toggleAllCart() {
            const allSelected = userCart.every(item => item.selected !== false);
            userCart.forEach(item => item.selected = !allSelected);
            saveCart();
            renderCart();
        }
        
        function checkout() {
            const selectedItems = userCart.filter(item => item.selected !== false);
            if (selectedItems.length === 0) return;

            const total = selectedItems.reduce((sum, item) => sum + item.price * item.qty, 0);
            const itemsList = selectedItems.map(item => `${item.name} (${item.qty} —à—Ç.)`).join('\n');
            const data = { 
                total_amount: total, 
                items: itemsList
            };

            tg.MainButton.showProgress();
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            setTimeout(() => {
                tg.MainButton.hideProgress();
                
                tg.showPopup({
                    title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑',
                    message: `–°—É–º–º–∞: ${formatPrice(total)} ‚ÇΩ. –í–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏.`,
                    buttons: [{ id: 'ok', type: 'default', text: '–û–ø–ª–∞—Ç–∏—Ç—å' }]
                }, (buttonId) => {
                    if (buttonId === 'ok') {
                         tg.readTextFromClipboard({
                            callback: (text) => {
                                // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞
                                tg.showPopup({
                                    title: '–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                                    message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏:',
                                    buttons: [{ id: 'send', type: 'default', text: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }]
                                }, (buttonId) => {
                                    if (buttonId === 'send') {
                                        tg.showPopup({
                                            title: '–£—Å–ø–µ—à–Ω–æ!',
                                            message: '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ù–∞–∂–º–∏—Ç–µ "–û–ö" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ.',
                                            buttons: [{ id: 'close', type: 'default', text: '–û–ö' }]
                                        }, (buttonId) => {
                                            if (buttonId === 'close') {
                                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
                                                tg.sendData(JSON.stringify({ 
                                                    action: 'checkout', 
                                                    items: selectedItems,
                                                    total: total,
                                                    phone: '79001234567' // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –≤–≤–µ–¥–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
                                                }));
                                            }
                                        });
                                    }
                                });
                            }
                         });
                    }
                });
            }, 500);
        }
        
        function openSupport() {
            tg.openTelegramLink(`https://t.me/${SUPPORT_USERNAME}`);
        }
        
        function openSettings() {
            document.getElementById('settings-modal').classList.add('modal-active');
            document.body.classList.add('no-scroll'); // V1.2: –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞
            
            const isLight = localStorage.getItem('theme') === 'light';
            document.getElementById('theme-toggle').checked = isLight;
            
            // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–π—á–∞—Å –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞)
            document.getElementById('lang-toggle').checked = false; 
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('modal-active');
            document.body.classList.remove('no-scroll'); // V1.2: –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞
        }
        
        function toggleLang() {
            tg.showAlert('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–º–µ–Ω—ã —è–∑—ã–∫–∞ –ø–æ–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.');
            document.getElementById('lang-toggle').checked = false; // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ EN (–≤—ã–∫–ª—é—á–µ–Ω–æ)
        }
        
        function clearFav() {
            if (userFav.length === 0) return;
            
            tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?', (isConfirmed) => {
                if (isConfirmed) {
                    userFav = [];
                    saveFav();
                    renderFav();
                    render();
                    tg.HapticFeedback.notificationOccurred('success');
                }
            });
        }


        // --- PULL-TO-REFRESH –õ–û–ì–ò–ö–ê ---
        
        function setupPullToRefresh(pageId) {
            const page = document.getElementById(pageId);
            const spinner = page.querySelector('#ptr-spinner') || page.querySelector('.ptr-spinner-all');
            
            if (!spinner) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ —Å–ø–∏–Ω–Ω–µ—Ä–∞

            let startY = 0;
            let isTouching = false;

            page.addEventListener('touchstart', e => {
                // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –∫–∞—Å–∞–Ω–∏—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                if (page.scrollTop === 0) {
                    startY = e.touches[0].clientY;
                    isTouching = true;
                }
            }, { passive: true });

            page.addEventListener('touchmove', e => {
                // –ï—Å–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω PTR –ò–õ–ò —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–∫—Ä—É—á–µ–Ω–∞ –≤–Ω–∏–∑ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                if (!isTouching || page.scrollTop !== 0) return; 

                const diff = e.touches[0].clientY - startY;
                
                // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê "–î–†–û–ñ–ê–ù–ò–Ø" –ü–†–ò –°–ö–†–û–õ–õ–ï –í–í–ï–†–• ---
                if (diff < 0) {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–∫—Ä–æ–ª–ª –í–í–ï–†–• —Å —Å–∞–º–æ–≥–æ –≤–µ—Ä—Ö–∞, 
                    // –æ—Ç–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏–∫—É PTR, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∏ –∏–∑–±–µ–∂–∞—Ç—å "–¥—Ä–æ–∂–∞–Ω–∏—è"
                    isTouching = false;
                    spinner.style.height = '0px'; 
                    return; 
                }
                // ---------------------------------------------------

                if (diff > 0) { // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—è–Ω–µ–º –í–ù–ò–ó
                    e.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã/–±—Ä–∞—É–∑–µ—Ä–∞
                    if (diff < 80) {
                        spinner.style.height = diff + 'px';
                    }
                }
            }, { passive: false });

            page.addEventListener('touchend', e => {
                if (!isTouching) return; // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ PTR, –≤—ã—Ö–æ–¥–∏–º

                isTouching = false; // –°–±—Ä–æ—Å
                spinner.style.transition = 'height 0.2s';
                
                if (parseInt(spinner.style.height) > 60) {
                    // Trigger refresh
                    spinner.style.height = '40px'; // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                    tg.HapticFeedback.impactOccurred('medium'); 
                    
                    // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    setTimeout(() => { 
                        if (pageId === 'p-home') render(); 
                        else if (pageId === 'p-fav') renderFav();
                        else if (pageId === 'p-cart') renderCart();
                        else if (pageId === 'p-prof') { /* –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ */ }
                        
                        spinner.style.height = '0px'; 
                    }, 1500);
                } else {
                    spinner.style.height = '0px'; // –°–ø—Ä—è—Ç–∞—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä
                }
                setTimeout(() => { spinner.style.transition = 'none'; }, 200);
            });
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = function() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
            } else if (tg.colorScheme === 'light') {
                document.body.classList.add('light-theme');
            }
            tg.is2022() && tg.setBgColor(document.body.classList.contains('light-theme') ? '#F2F2F7' : '#000000');


            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ SVG –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ fill/stroke
            document.querySelectorAll('.nav-icon').forEach(svg => {
                svg.querySelector('path').setAttribute('fill', 'currentColor');
            });
            document.querySelector('.logo-icon path').setAttribute('fill', 'currentColor');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PTR –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            setupPullToRefresh('p-home');
            setupPullToRefresh('p-cart');
            setupPullToRefresh('p-fav');
            setupPullToRefresh('p-prof');
            
            render(); 
            renderFav();
            renderCart();
            updateBadge(); 
            
            if(tg.initDataUnsafe?.user) {
                document.getElementById('u-name').innerText = tg.initDataUnsafe.user.first_name;
                if(tg.initDataUnsafe.user.photo_url) document.getElementById('u-ava').innerHTML = `<img src="${tg.initDataUnsafe.user.photo_url}" style="width:100%;height:100%;border-radius:50%">`;
            }
        }
    </script>

</body>
</html>
